<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BGB Demo Miner ‚Ä¢ Off‚Äëchain points ‚Ä¢ Manual payouts</title>
<link rel="icon" href="logo.png" />

<style>
:root{
  --accent:#e60000;--accent2:#cc0000;--ok:#00ff88;--warn:#f59e0b;--muted:#9aa0a6;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:#0b0f14;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
.overlay{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:22px 14px;gap:12px}

h1{font-weight:800;font-size:44px;letter-spacing:.2px;
  background:linear-gradient(90deg,#ff7a00,#ff3b3b);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.subtitle{color:#eaeaea}

.buttons{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
.btn{padding:12px 20px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;
  box-shadow:0 0 10px #e60000;cursor:pointer;text-decoration:none;display:inline-flex;gap:8px;align-items:center}
.btn:hover{background:var(--accent2);transform:translateY(-1px)}
.btn:focus-visible{outline:3px solid #fff3;outline-offset:2px}

.card{width:100%;max-width:980px;background:#101418;border:1px solid #1f2531;border-radius:18px;
  padding:16px 18px;box-shadow:0 4px 30px rgba(0,0,0,.35)}
.hdr{font-weight:800;font-size:20px;margin-bottom:6px}

.row{font-size:14px;margin:2px 0;opacity:.95}
.tags{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
.tag{background:#131a23;border:1px solid #263040;color:#cbd5e1;padding:4px 8px;border-radius:999px;font-size:12px}
.tag.ok{border-color:var(--ok);color:var(--ok)}
.tag.warn{border-color:var(--warn);color:var(--warn)}

.acc{font-size:20px;margin:6px 0}
.bar{height:8px;background:#ffffff22;border-radius:999px;overflow:hidden}
#bar{height:100%;width:0%;background:var(--ok);transition:width .3s}

.btns{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px}
.btn-red{padding:10px 18px;font-size:15px;border-radius:10px;background:var(--accent);color:#fff;border:none;
  box-shadow:0 0 10px #e60000;cursor:pointer}
.btn-red:hover{background:var(--accent2);transform:scale(1.05)}
.btn-red:focus-visible{outline:3px solid #fff3;outline-offset:2px}

.list{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;max-height:260px;overflow:auto;
  background:#0b0f14;border:1px solid #223043;border-radius:12px;padding:10px;margin-top:8px}
.list .ok{color:var(--ok)}
.list .try{color:#e5e7eb}
.list .sys{color:#9aa0a6}

footer{margin:16px 0;color:#9aa0a6}

/* Claim modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50;padding:16px}
.modal .card{max-width:720px;width:100%;background:#0f1318;border:1px solid #293241;border-radius:14px;color:#e5e7eb;padding:16px}
.modal h3{margin:0 0 6px 0}
.modal p{margin:0 0 10px 0;color:#9aa4ad;font-size:13px}
.modal pre{max-height:360px;overflow:auto;background:#0b0f14;border-radius:10px;padding:12px;font-size:12px;color:#d1d5db;border:1px solid #2a3240}
.modal .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
.modal .btn-red{padding:10px 16px;border-radius:10px;background:#e60000;border:none;color:#fff;cursor:pointer}
.modal .btn-red:hover{background:#cc0000}

/* A11y helpers */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
  <div class="overlay">
    <h1>BGB Demo Miner</h1>
    <div class="subtitle" aria-live="polite">üéÅ Off‚Äëchain ¬´–º–∞–π–Ω–∏–Ω–≥ –æ—á–∫–æ–≤¬ª. –†—É—á–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã –∞–¥–º–∏–Ω–æ–º –∏–∑ –∫–∞–∑–Ω–∞—á–µ–π—Å–∫–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞.</div>

    <div class="tags" role="note" aria-label="disclaimer">
      <span class="tag warn">Demo ‚Ä¢ Off‚Äëchain points ‚Ä¢ Not official Bitget BGB</span>
      <span class="tag">Server‚Äëverified shares</span>
      <span class="tag">EIP‚Äë712 signatures</span>
      <span class="tag">Manual payouts</span>
    </div>

    <div class="buttons">
      <a class="btn" href="https://bscscan.com/token/0xFeF80dbC16251862b82286864D77aFA08ECBcb5C" target="_blank" rel="noopener">üìÑ BSC Scan</a>
      <a class="btn" href="https://t.me/Makkan1985" target="_blank" rel="noopener">üí¨ Telegram</a>
      <button class="btn" onclick="openInMetaMask()" aria-label="Open in MetaMask Mobile">ü¶ä Open in MetaMask</button>
      <button class="btn" onclick="openInTrust()" aria-label="Open in Trust Wallet">üì± Open in Trust</button>
      <!-- –ö–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–∫–∏/–ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ —Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é; –≤–µ—Ä–Ω–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
      <a class="btn" style="display:none" href="https://pancakeswap.finance/add/BNB/0xFeF80dbC16251862b82286864D77aFA08ECBcb5C?chain=bsc" target="_blank" rel="noopener">üíß Add Liquidity</a>
      <a class="btn" style="display:none" href="https://pancakeswap.finance/swap?chain=bsc&outputCurrency=0xFeF80dbC16251862b82286864D77aFA08ECBcb5C" target="_blank" rel="noopener">üõí Buy on PancakeSwap</a>
    </div>

    <div class="card" aria-live="polite">
      <div class="hdr">BGB Demo Mining</div>

      <div class="row">Wallet: <span id="w">‚Äî</span></div>
      <div class="row">Session: <span id="sess">‚Äî</span> ‚Ä¢ Status: <span id="sesss">‚Äî</span></div>
      <div class="row">Hashrate: <span id="hr">‚Äî</span> ‚Ä¢ Difficulty bits: <span id="bits">‚Äî</span></div>
      <div class="row">Local height: <span id="h">0</span> ‚Ä¢ Last candidate: <span id="last">‚Äî</span></div>
      <div class="row">Target: <span id="tgt">‚Äî</span> ‚Ä¢ Next retarget in: <span id="rtg">‚Äî</span></div>

      <div class="tags">
        <span class="tag">Active miners (tabs): <b id="tabs">1</b></span>
        <span class="tag">Global miners: <b id="gminers">0</b></span>
        <span class="tag">Mempool: <b id="mpc">0</b> tx</span>
        <span class="tag">Avg fee: <b id="mpf">0.00</b> gwei</span>
        <span class="tag">Size: <b id="mps">0</b> kB</span>
        <span class="tag ok">Accepted (server): <b id="accp">0</b></span>
        <span class="tag">Blocks mined (global): <b id="bm">0</b></span>
      </div>

      <div class="acc">Accrued balance: <span id="acc">0.0000</span> <span id="sym">BGB</span></div>
      <div class="bar" aria-label="progress to min payout" role="progressbar" aria-valuemin="0" aria-valuemax="100">
        <div id="bar"></div>
      </div>
      <div class="row" id="msg">Ready</div>

      <div id="log" class="list" role="log" aria-live="polite" aria-relevant="additions"></div>

      <div class="btns">
        <button class="btn-red" onclick="doConnect()">Connect</button>
        <button class="btn-red" onclick="start()">Start</button>
        <button class="btn-red" onclick="stop()">Stop</button>
        <button class="btn-red" onclick="requestPayout()">Request Payout (‚â•100)</button>
        <button class="btn-red" onclick="toggleLog()">Toggle Log</button>
      </div>
    </div>

    <div class="card" style="max-width:980px">
      <div class="row">–ê–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Ç–æ–∫–µ–Ω–∞ (BSC): <code>0xFeF80dbC16251862b82286864D77aFA08ECBcb5C</code></div>
      <div class="row" style="margin-top:6px;color:#9aa0a6">–í–Ω–∏–º–∞–Ω–∏–µ: —ç—Ç–æ –¥–µ–º–æ‚Äë–º–∞–π–Ω–∏–Ω–≥ –æ—á–∫–æ–≤ –≤–Ω–µ –±–ª–æ–∫—á–µ–π–Ω–∞. –í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è –≤—Ä—É—á–Ω—É—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</div>
    </div>

    <footer>¬© 2025 BGB Demo Token</footer>
  </div>

  <!-- Claim Modal -->
  <div id="claim" class="modal" role="dialog" aria-modal="true" aria-labelledby="claimTitle">
    <div class="card">
      <h3 id="claimTitle">Claim Payload (–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π)</h3>
      <p>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ Telegram. –ê–¥–º–∏–Ω —Å–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Ç–æ–∫–µ–Ω—ã –≤—Ä—É—á–Ω—É—é.</p>
      <pre id="claimText">{}</pre>
      <div class="row">
        <button class="btn-red" onclick="copyClaim()">Copy</button>
        <button class="btn-red" onclick="openTG()">Open Telegram</button>
        <button class="btn-red" onclick="closeClaim()">Close</button>
      </div>
    </div>
  </div>

  <!-- Ethers v6 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js" crossorigin="anonymous"></script>

  <!-- Firebase (modular) ‚Äî –ü–û–î–°–¢–ê–í–¨ —Å–≤–æ–π databaseURL –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, onDisconnect, remove, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxVR12YVssinbr-dfZY8Wozjnou0TSpCM",
      authDomain: "bgb-miner.firebaseapp.com",
      projectId: "bgb-miner",
      storageBucket: "bgb-miner.firebasestorage.app",
      messagingSenderId: "1071946045783",
      appId: "1:1071946045783:web:3d91a09f70ed6d1e714612",
      measurementId: "G-53EZW3BDMX",
      databaseURL: "https://bgb-miner-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
    window.__bgb_firebase = { db, ref, onValue, set, onDisconnect, remove, serverTimestamp, runTransaction };
  </script>

  <!-- Main logic (module) -->
  <script>
  // ===== CONFIG
  const TOKEN_SYMBOL = 'BGB';             // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–∏–∫–µ—Ä
  const MIN_PAYOUT_BGB = 100n;            // –ø–æ—Ä–æ–≥ –≤—ã–ø–ª–∞—Ç—ã (–≤ —Ç–æ–∫–µ–Ω–∞—Ö)
  const UNIT = 10n ** 18n;                // 18 decimals
  const MIN_PAYOUT_WEI = MIN_PAYOUT_BGB * UNIT;

  // ===== helpers
  const $ = id => document.getElementById(id);
  const fmtB = (x, dp=4) => {
    const d = UNIT; const i = x / d; const f = (x % d).toString().padStart(18,'0').slice(0,dp);
    return `${i}.${f}`;
  };
  const k256 = s => ethers.keccak256(ethers.toUtf8Bytes(s));
  function randHex(n){ const a = new Uint8Array(n); crypto.getRandomValues(a); return Array.from(a, x=>x.toString(16).padStart(2,'0')).join(''); }
  function compactToTarget(bits){ const exp=(bits>>>24)&0xff; const mant=bits&0x007fffff; let t=BigInt(mant); const sh=8*(exp-3); return sh>=0? t*(1n<<BigInt(sh)) : t/(1n<<BigInt(-sh)); }
  function targetToCompact(t){ let e=3, n=BigInt(t); while(n>0x007fffffn){ n>>=8n; e++; } const m=Number(n&0x007fffffn); return ((e&0xff)<<24)|m; }

  // ===== constants (simulation)
  const BLOCK_REWARD = 1n * UNIT;       // —Å–µ—Ä–≤–µ—Ä –∑–∞—Å—á–∏—Ç–∞–µ—Ç –Ω–∞–≥—Ä–∞–¥—É; –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ ‚Äî —Ç–æ–ª—å–∫–æ UI
  const TRIES=128, LOG_MAX=600, VIEW_MAX=260;
  const BLOCK_TARGET_TIME=10, RETARGET_INTERVAL=20;
  const GENESIS = '0xf49bd1cb89367c32e3e3814b66ce02a181043f63f9af3dc1e9b5686faf15742d';
  const HR_UI = 5.00;

  // ===== EIP-712
  const EIP712_DOMAIN = (chainId)=>({ name: 'BGB-Miner-Demo', version: '1', chainId });
  const SESSION_TYPES = { Session: [
    { name: 'address',  type: 'address'  },
    { name: 'session',  type: 'bytes32'  },
    { name: 'issuedAt', type: 'uint256'  }
  ]};
  const CLAIM_TYPES = { Claim: [
    { name:'address',  type:'address' },
    { name:'amountWei',type:'uint256' },
    { name:'session',  type:'bytes32' },
    { name:'nonce',    type:'bytes32' },
    { name:'deadline', type:'uint256' }
  ]};

  // ===== state
  const KEY='bgb_demo_miner_v1';
  const DEF=()=>({ addr:null, running:false, accrued:0n, bits:0x1f00ffff, height:0, chain:[], shares:0, ctr:0, session:null, sessionOK:false });
  let S = DEF(), logBuf=[];

  // unique hash memory (anti-dup spam in UI only)
  const seen = new Set(); const queue=[];
  function remember(hash){ if(seen.has(hash)) return false; seen.add(hash); queue.push(hash); if(queue.length>4000){ const old=queue.shift(); seen.delete(old); } return true; }

  function save(){ try{ localStorage.setItem(KEY+':'+(S.addr||'guest'), JSON.stringify({...S, accrued:S.accrued.toString()})); }catch{} }
  function load(addr){ try{
      const raw=localStorage.getItem(KEY+':'+(addr||'guest'));
      if(!raw){ S=DEF(); S.addr=addr||null; return; }
      const p=JSON.parse(raw); S={...DEF(),...p}; if(typeof S.accrued==='string') S.accrued=BigInt(S.accrued); S.addr=addr||null;
    }catch{ S=DEF(); S.addr=addr||null; }
  }

  // active local tabs heartbeat
  const TAB_PREFIX='BGB_TAB_'; const TAB_ID=randHex(6);
  function heartbeat(){ try{ localStorage.setItem(TAB_PREFIX+TAB_ID, String(Date.now())); }catch{} }
  function countTabs(){ try{ const now=Date.now(), ttl=9000; let n=0; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && k.startsWith(TAB_PREFIX)){ const t=Number(localStorage.getItem(k)); if(now - t < ttl) n++; } } $('tabs').textContent=n||1; }catch{ $('tabs').textContent='1'; } }
  setInterval(()=>{ heartbeat(); countTabs(); }, 3000); heartbeat(); countTabs();

  // ===== Firebase presence & stats
  let FV = null; let presenceRef = null; let ackSubRef = null;
  function initFirebasePresence(){
    if (!window.__bgb_firebase) return;
    const { db, ref, onValue, set, onDisconnect, serverTimestamp } = window.__bgb_firebase;

    // presence node
    const clientId = (S.addr || 'guest') + '_' + TAB_ID;
    presenceRef = ref(db, 'presence/'+clientId);
    set(presenceRef, { ts: serverTimestamp(), ua: navigator.userAgent || '' }).catch(()=>{});
    try { onDisconnect(presenceRef).remove(); } catch {}

    // global miners count
    const rootPresence = ref(db, 'presence');
    onValue(rootPresence, (snap) => {
      $('gminers').textContent = snap.exists() ? (snap.size || Object.keys(snap.val()||{}).length) : 0;
    });

    // global blocks mined (if —Å–µ—Ä–≤–µ—Ä –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ç)
    const bmRef = ref(db, 'stats/blocksMined');
    onValue(bmRef, (snap) => { $('bm').textContent = snap.exists()? snap.val() : 0; });

    FV = { db, ref, onValue, set, onDisconnect, serverTimestamp };
  }

  // subscribe to balance
  function subscribeBalance(addr){
    try{
      const { db, ref, onValue } = window.__bgb_firebase;
      onValue(ref(db, 'balances/'+addr), (snap)=>{
        const wei = snap.exists()? BigInt(String(snap.val())) : 0n;
        S.accrued = wei; render();
      });
    }catch{}
  }

  // optional: subscribe to server acks for this session
  function subscribeAcks(){
    try{
      if(!S.session) return;
      const { db, ref, onValue } = window.__bgb_firebase;
      if(ackSubRef) return; // one-time bind
      ackSubRef = ref(db, 'acks/'+S.session);
      onValue(ackSubRef, (snap)=>{
        if (!snap.exists()) return;
        const v = snap.val();
        // v –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º {hash: ts}
        Object.keys(v).forEach((h)=>{
          pushLine(`ACCEPTED by server: ${h.slice(0,18)}‚Ä¶`, true);
          S.shares = (S.shares||0) + 1; $('accp').textContent = S.shares;
        });
      });
    }catch{}
  }

  // ===== UI
  let hrJ=0; let mp={c:0,f:0,s:0};
  function pushLine(html,cls){ logBuf.push({html,cls}); if(logBuf.length>LOG_MAX) logBuf.shift(); }
  function render(){
    $('sym').textContent = TOKEN_SYMBOL;
    $('w').textContent = S.addr? S.addr.slice(0,6)+'‚Ä¶'+S.addr.slice(-4) : '‚Äî';
    $('sess').textContent = S.session? S.session.slice(0,10)+'‚Ä¶' : '‚Äî';
    $('sesss').textContent = S.session? (S.sessionOK?'OK':'pending') : '‚Äî';

    hrJ += (Math.random()-0.5)*0.1; hrJ=Math.max(-0.5,Math.min(0.5,hrJ));
    const hr=Math.max(0,HR_UI*(1+hrJ/10)).toFixed(2);
    $('hr').textContent = `${hr} H/s`;
    $('bits').textContent = '0x'+S.bits.toString(16);
    $('h').textContent = S.height;
    $('last').textContent = S.height? (S.chain.at(-1).hash.slice(0,10)+'‚Ä¶') : '‚Äî';
    const tgt=compactToTarget(S.bits); $('tgt').textContent = '0x'+tgt.toString(16).slice(0,16)+'‚Ä¶';
    $('rtg').textContent = RETARGET_INTERVAL - (S.height % RETARGET_INTERVAL || RETARGET_INTERVAL);
    $('acc').textContent = fmtB(S.accrued,4);
    const pct = Number(S.accrued*100n/MIN_PAYOUT_WEI);
    $('bar').style.width = Math.min(100, pct) + '%';

    $('accp').textContent = S.shares||0;

    const log=$('log');
    log.innerHTML=[
      `<div class="sys">Log (white = try, green = accepted)</div>`,
      ...logBuf.slice(-VIEW_MAX).map(e=>`<div class="${e.cls||'try'}">${e.html}</div>`).reverse()
    ].join('');
  }

  function updMP(){ $('mpc').textContent=mp.c; $('mpf').textContent=mp.f.toFixed(2); $('mps').textContent=mp.s; }

  function retarget(){
    if(S.height<RETARGET_INTERVAL) return;
    const from=S.chain.length-RETARGET_INTERVAL, first=S.chain[from], last=S.chain.at(-1);
    const actual=Math.max(1,last.time-first.time), span=BLOCK_TARGET_TIME*RETARGET_INTERVAL;
    const oldT=compactToTarget(S.bits); let newT=oldT*BigInt(actual)/BigInt(span);
    const minT=oldT/4n,maxT=oldT*4n; if(newT<minT)newT=minT; if(newT>maxT)newT=maxT;
    S.bits=targetToCompact(newT);
  }

  function mineBatch(){
    const prev=S.height?S.chain.at(-1).hash:GENESIS;
    const tgt=compactToTarget(S.bits), now=Math.floor(Date.now()/1000);

    for(let i=0;i<TRIES;i++){
      const nonce=randHex(8), salt=randHex(4), ctr=++S.ctr;
      const header=JSON.stringify({ver:1,prev,time:now,bits:S.bits,nonce,salt,ctr});
      const h=k256(header);

      if(!remember(h)) { i--; continue; }

      const line=`${h} bits=0x${S.bits.toString(16)} nonce=${nonce} salt=${salt} ctr=${ctr} ‚Üê ${prev.slice(0,18)}‚Ä¶`;

      if(BigInt(h)<=tgt){
        const blk={idx:S.height+1,time:now,bits:S.bits,nonce,prev,hash:h};
        S.chain.push(blk); S.height=blk.idx;
        pushLine(`${line}  (candidate ‚Üí submit)`, 'try');
        submitShare(blk);
        if(S.height % RETARGET_INTERVAL===0) retarget();
        render(); return;
      } else {
        pushLine(line,'try');
      }
    }
  }

  function tick(){
    if(!S.running) return;
    // –ø—Å–µ–≤–¥–æ-–º–µ–º–ø—É–ª
    mp.c=Math.max(0,Math.round(mp.c+(Math.random()*6-3)));
    mp.f=Math.max(0.1,mp.f+(Math.random()*0.2-0.1));
    mp.s=Math.max(0,Math.round(mp.s+(Math.random()*6-3)));
    updMP();

    mineBatch(); save(); render();
  }

  // ===== wallet & sessions
  async function doConnect(){
    try{
      const injected=(window.__bgb_provider||window.ethereum);
      if(!injected){ alert('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ MetaMask –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ Trust Wallet DApp.'); return; }
      if(injected.request){ await injected.request({method:'eth_requestAccounts'}); }
      const p=new ethers.BrowserProvider(injected); const s=await p.getSigner(); const addr=await s.getAddress();
      load(addr); S.addr=addr; S.sessionOK=false; save(); render();
      initFirebasePresence(); subscribeBalance(addr);
      $('msg').textContent='Wallet connected';
    }catch(e){ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫'); }
  }

  async function attestSession(){
    try{
      const injected=(window.__bgb_provider||window.ethereum); if(!injected) throw new Error('No provider');
      const provider=new ethers.BrowserProvider(injected); const signer=await provider.getSigner();
      const addr=await signer.getAddress(); const { chainId }=await provider.getNetwork();
      if(!S.session) S.session = '0x'+randHex(32);
      const issuedAt = Math.floor(Date.now()/1000);
      const domain = EIP712_DOMAIN(Number(chainId));
      const value  = { address: addr, session: S.session, issuedAt };
      const sig = await signer.signTypedData(domain, SESSION_TYPES, value);

      // –ø–∏—à–µ–º –≤ RTDB: sessions/{addr}/{session}
      const { db, ref, set, serverTimestamp } = window.__bgb_firebase;
      await set(ref(db, `sessions/${addr}/${S.session}`), {
        address: addr, session: S.session, issuedAt, chainId: Number(chainId), sig, ts: serverTimestamp()
      });

      // —Å–ª—É—à–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å ok: true)
      const { onValue } = window.__bgb_firebase;
      onValue(ref(db, `sessions/${addr}/${S.session}/ok`), (snap)=>{
        S.sessionOK = !!(snap.exists() && snap.val());
        $('sesss').textContent = S.sessionOK? 'OK' : 'pending';
      });

      subscribeAcks();
      render();
      return { addr, chainId:Number(chainId), session:S.session, issuedAt, sig };
    }catch(e){ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–µ—Å—Å–∏—é'); return null; }
  }

  async function start(){
    if(!S.addr){ alert('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ (Connect)'); return; }
    $('msg').textContent='Preparing session‚Ä¶';
    const sess = await attestSession();
    if(!sess){ $('msg').textContent='Session error'; return; }
    S.running=true; $('msg').textContent='Mining‚Ä¶';
  }
  function stop(){ S.running=false; $('msg').textContent='Paused'; }
  function toggleLog(){ const el=$('log'); el.style.display=(el.style.display==='none'?'block':'none'); }

  // ===== share submit ‚Üí server (RTDB)
  async function submitShare(blk){
    try{
      const { db, ref, set, serverTimestamp } = window.__bgb_firebase || {};
      if(!db){ pushLine('! Firebase not ready','sys'); return; }
      if(!S.addr || !S.session){ pushLine('! No session/address','sys'); return; }
      const key = blk.hash;
      const payload = {
        addr: S.addr, session: S.session,
        header: { ver:1, prev:blk.prev, time:blk.time, bits:blk.bits, nonce:blk.nonce, salt:blk.salt, ctr:S.ctr },
        hash: blk.hash, bits: blk.bits, ts: serverTimestamp(), ua: navigator.userAgent || ''
      };
      await set(ref(db, 'incoming/'+key), payload);
      pushLine(`submitted ‚Üí server: ${key.slice(0,18)}‚Ä¶`, 'sys');
    }catch(e){ console.error(e); pushLine('! submit error','sys'); }
  }

  // ===== Claim (manual payout)
  async function buildClaim(amountWei){
    const injected=(window.__bgb_provider||window.ethereum);
    const provider = new ethers.BrowserProvider(injected);
    const signer = await provider.getSigner();
    const addr = await signer.getAddress();
    const { chainId } = await provider.getNetwork();

    const deadline = Math.floor(Date.now()/1000) + 15*60; // 15 –º–∏–Ω—É—Ç
    const nonce = '0x'+randHex(32);

    const domain = EIP712_DOMAIN(Number(chainId));
    const value  = { address: addr, amountWei: amountWei.toString(), session: S.session, nonce, deadline };
    const sig    = await signer.signTypedData(domain, CLAIM_TYPES, value);

    return { addr, chainId:Number(chainId), amountWei: amountWei.toString(), session:S.session, nonce, deadline, sig };
  }

  async function requestPayout(){
    if(!S.addr){ alert('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ (Connect)'); return; }
    const bal = S.accrued || 0n;
    if(bal < MIN_PAYOUT_WEI){ alert(`–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${MIN_PAYOUT_BGB} ${TOKEN_SYMBOL}`); return; }
    if(!S.session){ const ok = await attestSession(); if(!ok) return; }

    const pay = bal - (bal % MIN_PAYOUT_WEI);
    const claim = await buildClaim(pay);

    $('claimText').textContent = JSON.stringify({ type:'BGB-Miner-Manual-Claim', token: TOKEN_SYMBOL, ...claim }, null, 2);
    $('claim').style.display='flex';
  }
  async function copyClaim(){ try{ await navigator.clipboard.writeText($('claimText').textContent); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∞–¥–º–∏–Ω—É –≤ Telegram.'); }catch{} }
  function openTG(){ const txt=encodeURIComponent('–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É BGB:\n\n'+$('claimText').textContent); window.open('https://t.me/share/url?url=&text='+txt,'_blank','noopener,noreferrer'); }
  function closeClaim(){ $('claim').style.display='none'; }

  // ===== Deep links
  function openInMetaMask(){ const dapp = location.href.replace(/^https?:\/\//,''); window.location.href = 'https://metamask.app.link/dapp/'+ dapp; }
  function openInTrust(){ const dappUrl = encodeURIComponent(location.href); window.location.href = `https://link.trustwallet.com/open_url?source=dapp&url=${dappUrl}`; }
  window.openInMetaMask = openInMetaMask; window.openInTrust = openInTrust;

  // expose actions
  window.doConnect = doConnect; window.start = start; window.stop = stop; window.requestPayout = requestPayout; window.toggleLog = toggleLog; window.copyClaim = copyClaim; window.openTG = openTG; window.closeClaim = closeClaim;

  // ===== boot
  load(null);
  $('sym').textContent = TOKEN_SYMBOL;
  pushLine('Mining log (white = try, green = accepted)', 'sys');
  render(); updMP();
  setInterval(tick,500);

  // –∞–≤—Ç–æ–ø–æ–¥—Ö–≤–∞—Ç –∞–¥—Ä–µ—Å–∞ + presence
  if (window.ethereum) {
    window.ethereum.request({method:'eth_accounts'}).then(acc=>{
      if(acc && acc[0]){ load(acc[0]); S.addr=acc[0]; render(); initFirebasePresence(); subscribeBalance(S.addr); }
    }).catch(()=>{});
  } else {
    initFirebasePresence();
  }
  </script>
</body>
</html>
