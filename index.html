<script>
(function(){
  // === Константы / состояние ===
  const KEY = 'bgb_btclike_miner_keccak_v1';
  const BASE_RATE = 5n * 10n**16n;  // 0.05 BGB/s (визуально)
  const UNIT = 30n * 10n**18n;      // 30 BGB
  const BLOCK_TARGET_TIME = 10;     // сек/блок (ускорено)
  const RETARGET_INTERVAL = 20;     // пересчёт каждые N блоков
  const MAX_VIEW = 200;

  let st = {
    addr:null, running:false, lastMs:Date.now(), accrued:0n,
    bits:0x1f00ffff, height:0, chain:[], session:rndHex(16)
  };

  // === Вспомогательные ===
  const $ = id => document.getElementById(id);
  function rndHex(n){ const a=new Uint8Array(n); (crypto.getRandomValues?crypto.getRandomValues(a):a.fill(0)); return Array.from(a,x=>x.toString(16).padStart(2,'0')).join(''); }
  function fmt(big,dp=4){ const d=10n**18n; const i=big/d; const f=(big%d).toString().padStart(18,'0').slice(0,dp); return `${i}.${f}`; }
  function save(){ try{ localStorage.setItem(KEY, JSON.stringify({...st, accrued: st.accrued.toString()})); }catch{} }
  function load(){ try{ const x=JSON.parse(localStorage.getItem(KEY)||'null'); if(x){ st=Object.assign(st,x); if(typeof st.accrued==='string') st.accrued=BigInt(st.accrued); } }catch{} }

  // compact bits <-> target (упрощённо)
  function compactToTarget(bits){
    const exp=(bits>>>24)&0xff, mant=bits&0x007fffff;
    let t=BigInt(mant); const shift=8*(exp-3);
    t = shift>=0 ? t*(1n<<BigInt(shift)) : t/(1n<<BigInt(-shift));
    return t;
  }
  function targetToCompact(target){
    let exp=3, t=BigInt(target); while(t>0x007fffffn){ t>>=8n; exp++; }
    const mant=Number(t&0x007fffffn); return ((exp&0xff)<<24)|mant;
  }
  const curTarget = ()=>compactToTarget(st.bits);
  const k256 = s => ethers.keccak256(ethers.toUtf8Bytes(s));

  // === Рендер ===
  function render(){
    $('sm-addr').textContent   = st.addr ? `${st.addr.slice(0,6)}…${st.addr.slice(-4)}` : '—';
    $('sm-bits').textContent   = '0x'+st.bits.toString(16);
    $('sm-height').textContent = st.height;
    $('sm-target').textContent = '0x'+curTarget().toString(16).slice(0,16)+'…';
    $('sm-acc').textContent    = fmt(st.accrued,4);
    $('sm-last').textContent   = st.height ? st.chain.at(-1).hash.slice(0,10)+'…' : '—';
    $('sm-retarget').textContent = RETARGET_INTERVAL - (st.height % RETARGET_INTERVAL || RETARGET_INTERVAL);

    // прогресс к 30 BGB
    const pct = Math.min(100, Number(st.accrued * 100n / UNIT));
    $('sm-bar').style.width = pct + '%';

    // хешрейт — просто стабильное число для UI
    const hr = Number(BASE_RATE / 10n**14n)/100;
    $('sm-hr').textContent = `${hr.toFixed(2)} BGB/s`;

    const list = $('sm-chain');
    if(!list.hasAttribute('hidden')){
      list.innerHTML = st.chain.slice(-MAX_VIEW).map(b =>
        `<div>#${b.idx} t=${new Date(b.time*1000).toLocaleTimeString()} bits=0x${b.bits.toString(16)} nonce=${b.nonce}<br>${b.hash} ← ${b.prev}</div>`
      ).reverse().join('');
    }
  }

  // === Майнинг (быстрый, синхронный на keccak, без WebCrypto) ===
  function mineBatch(){
    const prev   = st.height ? st.chain.at(-1).hash : '0x'+'00'.repeat(32);
    const target = curTarget();
    const tries  = 512;               // сколько нонсов за тик
    const nowSec = Math.floor(Date.now()/1000);
    for(let i=0;i<tries;i++){
      const nonce  = rndHex(8);
      const header = JSON.stringify({ver:1, prev, time: nowSec, bits: st.bits, nonce, merkle: rndHex(16)});
      const h      = k256(header);
      if (BigInt(h) <= target){
        const blk = { idx: st.height+1, time: nowSec, bits: st.bits, nonce, prev, hash: h };
        st.chain.push(blk); st.height = blk.idx;
        if(st.chain.length>MAX_VIEW) st.chain = st.chain.slice(-MAX_VIEW);
        $('sm-msg').textContent = `Mined block #${blk.idx}`;
        if(st.height % RETARGET_INTERVAL === 0) retarget();
        return true;
      }
    }
    return false;
  }

  function retarget(){
    if(st.height < RETARGET_INTERVAL) return;
    const from = st.chain.length-RETARGET_INTERVAL;
    const first = st.chain[from], last = st.chain.at(-1);
    const actual = Math.max(1, last.time - first.time);
    const targetSpan = BLOCK_TARGET_TIME * RETARGET_INTERVAL;

    let newT = curTarget() * BigInt(actual) / BigInt(targetSpan);
    const cur = curTarget();
    const minT = cur/4n, maxT = cur*4n;
    if(newT < minT) newT = minT;
    if(newT > maxT) newT = maxT;
    st.bits = targetToCompact(newT);
  }

  function tick(){
    if(!st.running) return;
    const now=Date.now(), dt=now-st.lastMs;
    if(dt<=0) return;
    st.accrued += BASE_RATE * BigInt(Math.floor(dt/1000));
    st.lastMs = now;
    mineBatch();
    save(); render();
  }

  // === Обработчики кнопок (глобально) ===
  window.smConnect = async function(){
    if(!window.ethereum){ alert('Установите MetaMask'); return; }
    try{ const p=new ethers.BrowserProvider(window.ethereum); const s=await p.getSigner(); st.addr=await s.getAddress(); save(); render(); }
    catch{ alert('Не удалось подключить кошелёк'); }
  };
  window.smStart = function(){ st.running=true; st.lastMs=Date.now(); $('sm-msg').textContent='Mining…'; save(); render(); };
  window.smStop  = function(){ st.running=false; $('sm-msg').textContent='Paused'; save(); render(); };
  window.smReset = function(){ if(confirm('Сбросить локальные данные майнера?')){ st.accrued=0n; st.chain=[]; st.height=0; st.lastMs=Date.now(); st.bits=0x1f00ffff; $('sm-msg').textContent='Reset done'; save(); render(); } };
  window.smToggleChain = function(){ const el=$('sm-chain'); if(el.hasAttribute('hidden')) el.removeAttribute('hidden'); else el.setAttribute('hidden',''); render(); };

  // Payout-заявка в TG (как раньше)
  window.smRequest = async function(){
    if(st.accrued < UNIT){ alert('Нужно ≥30 BGB'); return; }
    if(!window.ethereum){ alert('Подключите MetaMask'); return; }
    try{
      const p=new ethers.BrowserProvider(window.ethereum), s=await p.getSigner(), addr=await s.getAddress();
      const payoutWei = st.accrued - (st.accrued % UNIT);
      const amountBGB = fmt(payoutWei,4);
      const last = st.chain.at(-1);
      const payload = { address:addr, session:st.session, amountBGB, amountWei:payoutWei.toString(), height:st.height, lastBlock:last?last.hash:null, bits:st.bits, ts:new Date().toISOString() };
      const msg = `BGB Claim Request\nAddress: ${addr}\nSession: ${st.session}\nAmount: ${amountBGB} BGB\nHeight: ${st.height}\nBits: 0x${st.bits.toString(16)}\nLast: ${last?last.hash:'-'}\nTime: ${payload.ts}`;
      const sig = await s.signMessage(msg);
      try{ await navigator.clipboard.writeText(JSON.stringify({...payload,signature:sig},null,2)); }catch{}
      const share = `https://t.me/share/url?url=&text=${encodeURIComponent(msg+'\n\nSignature: '+sig)}`;
      window.open(share,'_blank','noopener,noreferrer');
      $('sm-msg').innerHTML='Заявка сформирована. Откройте <a href="https://t.me/Makkan1985" target="_blank" rel="noopener">Telegram</a> и отправьте payload.';
    }catch(e){ alert('Ошибка запроса'); console.error(e); }
  };

  // === Запуск ===
  load(); render();
  setInterval(tick, 500); // лёгкий цикл
})();
</script>
