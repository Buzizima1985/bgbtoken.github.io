<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BGB Token ‚Ä¢ Mining</title>
<link rel="icon" href="logo.png"/>

<style>
  :root{--accent:#e60000;--accent2:#cc0000;--ok:#00ff88;--txt:#fff}
  *{box-sizing:border-box;margin:0;padding:0}
  body,html{height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:#0b0f14 url('./bg.jpg') no-repeat center/cover}
  .overlay{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:24px 16px;gap:14px;background:radial-gradient(1000px 500px at 50% -10%,#21374733 5%,#0b0f14 60%)}
  h1{font-weight:800;font-size:44px;line-height:1;background:linear-gradient(90deg,#ff7a00,#ff3b3b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-top:6px}
  .subtitle{color:#eaeaea;font-size:16px;margin-bottom:6px}
  .buttons{display:flex;flex-wrap:wrap;justify-content:center;gap:12px}
  .btn{padding:12px 20px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;box-shadow:0 0 10px #e60000;cursor:pointer;font-size:16px;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  .btn:hover{background:var(--accent2);transform:translateY(-1px)}

  .miner-card{max-width:720px;width:100%;margin:18px auto;padding:16px 18px;background:rgba(0,0,0,.28);backdrop-filter:blur(4px);border-radius:18px;color:#fff}
  .miner-card .hdr{font-weight:800;font-size:20px;margin-bottom:6px}
  .miner-card .row{font-size:14px;margin:2px 0;opacity:.95}
  .miner-card .acc{font-size:20px;margin:8px 0}
  .miner-card .bar{height:8px;background:#ffffff22;border-radius:999px;overflow:hidden;margin:6px 0}
  #sm-bar{height:100%;width:0%;background:#00ff88;transition:width .30s ease}
  .mempool{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0}
  .tag{background:#131820;color:#cbd5e1;border:1px solid #2a3240;padding:4px 8px;border-radius:999px;font-size:12px}
  .tag.success{border-color:#00ff88;color:#00ff88}
  #miners-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .miner-card .btns{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:8px}
  .miner-card .btn-red{padding:10px 18px;font-size:15px;border-radius:10px;background:var(--accent);color:#fff;border:none;box-shadow:0 0 10px #e60000;cursor:pointer}
  .miner-card .btn-red:hover{background:var(--accent2);transform:scale(1.05)}

  .list{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;max-height:200px;overflow:auto;background:#0b0f14;border:1px solid #2a3240;padding:8px;border-radius:10px;margin-top:6px;text-align:left;color:#e5e7eb}
  .list .ok{color:#00ff88}     /* –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ (—Å –Ω–∞–≥—Ä–∞–¥–æ–π) */
  .list .empty{color:#e5e7eb}  /* –ø—É—Å—Ç—ã–µ –ø–æ–ø—ã—Ç–∫–∏ / –∑–∞–≥–æ–ª–æ–≤–∫–∏ */

  footer{margin-top:20px;color:#a9b0b6;font-size:13px}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50;padding:16px}
  .modal .card{max-width:680px;width:100%;background:#0f1318;border:1px solid #293241;border-radius:14px;color:#e5e7eb;padding:16px;text-align:left}
  .modal pre{max-height:360px;overflow:auto;background:#0b0f14;border-radius:10px;padding:12px;font-size:12px;color:#d1d5db}
  .modal .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
  <div class="overlay">
    <h1>BGB Token</h1>
    <div class="subtitle">üéÅ –ü–æ–ª—É—á–∏ <b>300 BGB</b> –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –Ω–∞ —Å–≤–æ–π –∫–æ—à–µ–ª—ë–∫</div>

    <div class="buttons">
      <a class="btn" href="https://bscscan.com/token/0xFeF80dbC16251862b82286864D77aFA08ECBcb5C" target="_blank" rel="noopener">üìÑ BSC Scan</a>
      <a class="btn" href="https://t.me/Makkan1985" target="_blank" rel="noopener">üí¨ Telegram</a>
      <button class="btn" onclick="handleMetaMask(event)">ü¶ä MetaMask</button>
      <button class="btn" onclick="handleTrust(event)">üîì Trust Wallet</button>
      <a class="btn" href="https://pancakeswap.finance/add/BNB/0xFeF80dbC16251862b82286864D77aFA08ECBcb5C?chain=bsc" target="_blank" rel="noopener">üíß Add Liquidity</a>
      <a class="btn" href="https://pancakeswap.finance/swap?chain=bsc&outputCurrency=0xFeF80dbC16251862b82286864D77aFA08ECBcb5C" target="_blank" rel="noopener">üõí Buy on PancakeSwap</a>
      <a class="btn" href="https://www.geckoterminal.com/ru/bsc/pools/0x5d498d6a3a36187e4c22c5628b0fbeb068fe405a" target="_blank" rel="noopener">üß≠ GeckoTerminal</a>
    </div>

    <div id="miner" class="miner-card" aria-live="polite">
      <div class="hdr">BGB Mining</div>
      <div class="row">Wallet: <span id="sm-addr">‚Äî</span></div>
      <div class="row">Hashrate: <span id="sm-hr">‚Äî</span> ‚Ä¢ Difficulty bits: <span id="sm-bits">‚Äî</span></div>
      <div class="row">Height: <span id="sm-height">0</span> ‚Ä¢ Last block: <span id="sm-last">‚Äî</span></div>
      <div class="row">Target: <span id="sm-target">‚Äî</span> ‚Ä¢ Next retarget in: <span id="sm-retarget">‚Äî</span></div>

      <div class="row" id="miners-row">
        <span class="tag">Active miners (global): <b id="sm-online-global">‚Äî</b></span>
        <span class="tag success">Local tabs: <b id="sm-online-local">1</b></span>
      </div>

      <div class="mempool">
        <span class="tag">Mempool: <b id="mp-count">0</b> tx</span>
        <span class="tag">Avg fee: <b id="mp-fee">0.00</b> gwei</span>
        <span class="tag">Size: <b id="mp-size">0</b> kB</span>
        <span class="tag success">Accepted: <b id="sm-shares">0</b></span>
      </div>

      <div class="acc">Accrued: <span id="sm-acc">0.0000</span> BGB</div>
      <div class="bar"><div id="sm-bar"></div></div>
      <div class="row" id="sm-msg">Status: ready</div>
      <!-- —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
      <div id="sm-chain" class="list"></div>

      <div class="btns">
        <button type="button" class="btn-red" onclick="smConnect()">Connect</button>
        <button type="button" class="btn-red" onclick="smStart()">Start</button>
        <button type="button" class="btn-red" onclick="smStop()">Stop</button>
        <button type="button" class="btn-red" onclick="smRequest()">Request Payout (‚â•30 BGB)</button>
        <button type="button" class="btn-red" onclick="smToggleChain()">Chain</button>
      </div>
    </div>

    <div class="miner-card" style="max-width:720px">
      <div class="row">–ö–æ–Ω—Ç—Ä–∞–∫—Ç —Ç–æ–∫–µ–Ω–∞: <code>0xFeF80dbC16251862b82286864D77aFA08ECBcb5C</code></div>
    </div>

    <footer>¬© 2025 BGB Token</footer>
  </div>

  <!-- Claim modal -->
  <div id="claim-modal" class="modal" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin-bottom:8px">Claim Payload</h3>
      <pre id="claim-json">{}</pre>
      <div class="row">
        <button class="btn-red" onclick="copyClaim()">Copy</button>
        <button class="btn-red" onclick="sendClaim()">Open Telegram</button>
        <button class="btn-red" onclick="closeClaim()">Close</button>
      </div>
    </div>
  </div>

  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>

  <!-- Firebase (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á—ë—Ç—á–∏–∫–∞) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
  // ===== FIREBASE CONFIG (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  const FIREBASE = {
    enabled: false, // <- –≤–∫–ª—é—á–∏ true –∏ –≤—Å—Ç–∞–≤—å –∫–æ–Ω—Ñ–∏–≥, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –º–∞–π–Ω–µ—Ä–æ–≤
    config: {
      apiKey:     "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL:"https://YOUR_PROJECT-default-rtdb.firebaseio.com",
      projectId:  "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    }
  };
  </script>

  <script>
  // ===== –í–µ—Ä—Ö–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
  async function handleMetaMask(e){
    e && e.preventDefault && e.preventDefault();
    const token={address:'0xFeF80dbC16251862b82286864D77aFA08ECBcb5C',symbol:'BGB',decimals:18,image:'logo.png'};
    if(window.ethereum && window.ethereum.request){
      try{ await window.ethereum.request({method:'wallet_watchAsset',params:{type:'ERC20',options:token}}); }
      catch{ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ MetaMask'); }
    }else{ window.open('https://metamask.io/download/','_blank','noopener,noreferrer'); }
  }
  function handleTrust(e){
    e && e.preventDefault && e.preventDefault();
    const ua=navigator.userAgent||''; const dapp=encodeURIComponent(location.href);
    const openUrl=`https://link.trustwallet.com/open_url?source=dapp&url=${dapp}`;
    if(/Android/i.test(ua)){ location.href=openUrl; setTimeout(()=>window.open('https://play.google.com/store/apps/details?id=com.wallet.crypto.trustapp','_blank'),900); return; }
    if(/iPhone|iPad|iPod/i.test(ua)){ window.open('https://apps.apple.com/app/trust-crypto-bitcoin-wallet/id1288339409','_blank'); alert('–ù–∞ iOS –æ—Ç–∫—Ä–æ–π —Å–∞–π—Ç —á–µ—Ä–µ–∑ Trust Wallet (Browser).'); return; }
    window.open('https://trustwallet.com/download','_blank');
  }

  // ===== –ú–∞–π–Ω–µ—Ä (—Å –ª–æ–≥–æ–º –ø—É—Å—Ç—ã—Ö/–ø—Ä–∏–Ω—è—Ç—ã—Ö, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ö—ç—à–∏, per-wallet —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
  (function(){
    // --- –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const GENESIS_PREV='0xf49bd1cb89367c32e3e3814b66ce02a181043f63f9af3dc1e9b5686faf15742d';
    const UNIT=30n*10n**18n;             // 30 BGB
    const BASE_RATE=5n*10n**16n;         // ¬´–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–µ–∫¬ª –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    const BLOCK_TARGET_TIME=10;          // —Å–µ–∫ –Ω–∞ –±–ª–æ–∫ (—Ü–µ–ª–µ–≤–æ–π)
    const RETARGET_INTERVAL=20;          // –∫–∞–∂–¥—ã–µ N –±–ª–æ–∫–æ–≤ ‚Äî –ø–µ—Ä–µ—Å—á—ë—Ç
    const TRIES=128;                     // –ø–æ–ø—ã—Ç–æ–∫ –≤ –æ–¥–∏–Ω —Ç–∏–∫ (–∑–∞–º–µ–¥–ª–∏–ª)
    const MAX_VIEW=200;                  // —Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
    const LOG_MAX=400;                   // –¥–ª–∏–Ω–∞ –∫–æ–ª—å—Ü–µ–≤–æ–≥–æ –±—É—Ñ–µ—Ä–∞ –ª–æ–≥–∞

    // --- presence –ª–æ–∫–∞–ª—å–Ω—ã–π (tabs)
    const ONLINE_KEY='bgb_online_tabs_v1', CH_NAME='bgb_online_broadcast_v1';
    const tabId = randHex(12); const bc=('BroadcastChannel' in window)?new BroadcastChannel(CH_NAME):null;
    function getMap(){ try{return JSON.parse(localStorage.getItem(ONLINE_KEY)||'{}')}catch{return{}} }
    function setMap(m){ localStorage.setItem(ONLINE_KEY, JSON.stringify(m)) }
    function cleanup(m){ const now=Date.now(),t=15000; for(const k in m){ if((now-m[k])>t) delete m[k]; } return m; }
    function setLocalOnline(n){ const el=document.getElementById('sm-online-local'); if(el) el.textContent=n; }
    function touchLocal(){ let m=cleanup(getMap()); m[tabId]=Date.now(); setMap(m); const n=Object.keys(m).length; setLocalOnline(n); bc&&bc.postMessage({type:'online',n}); }
    touchLocal(); setInterval(touchLocal,5000);
    window.addEventListener('storage',e=>{ if(e.key===ONLINE_KEY){ const n=Object.keys(cleanup(getMap())).length; setLocalOnline(n); }});
    bc&&bc.addEventListener('message',e=>{ if(e.data?.type==='online') setLocalOnline(e.data.n); });
    window.addEventListener('beforeunload',()=>{ const m=getMap(); delete m[tabId]; setMap(m); bc&&bc.postMessage({type:'online',n:Object.keys(m).length}); });

    // --- Firebase global (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    function setGlobalOnline(n){ const el=document.getElementById('sm-online-global'); if(el) el.textContent=n; }
    (function initFirebase(){
      try{
        if(!FIREBASE.enabled){ setGlobalOnline('‚Äî'); return; }
        const app = firebase.initializeApp(FIREBASE.config);
        const db = firebase.database();
        const key='tab_'+randHex(8); const ref=db.ref('presence/'+key);
        ref.onDisconnect().remove();
        function beat(){
          ref.set({ts:Date.now()}).catch(()=>{});
          db.ref('presence').on('value',snap=>{
            const val=snap.val()||{}; const now=Date.now(); let n=0;
            for(const k in val){ if(now-(val[k]?.ts||0)<=15000) n++; }
            setGlobalOnline(n);
          });
        }
        beat(); setInterval(beat,5000);
      }catch(e){ console.warn('Firebase disabled:',e); setGlobalOnline('‚Äî'); }
    })();

    // --- —Å–æ—Å—Ç–æ—è–Ω–∏–µ per-wallet (v3)
    const KEY_BASE='bgb_miner_ui_v3';
    function makeKey(addr){ return KEY_BASE + ':' + (addr?addr.toLowerCase():'guest'); }
    const DEFAULT=()=>({addr:null,running:false,lastMs:Date.now(),accrued:0n,bits:0x1f00ffff,height:0,chain:[],shares:0,ctr:0,session:randHex(16)});
    let st=DEFAULT();

    function save(){ try{ localStorage.setItem(makeKey(st.addr), JSON.stringify({...st,accrued:st.accrued.toString()})); }catch{} }
    function loadFor(addr){
      try{
        const raw=localStorage.getItem(makeKey(addr));
        if(!raw){ st=DEFAULT(); st.addr=addr||null; return; }
        const p=JSON.parse(raw); st={...DEFAULT(),...p};
        if(typeof st.accrued==='string') st.accrued=BigInt(st.accrued);
        st.addr=addr||null;
      }catch{ st=DEFAULT(); st.addr=addr||null; }
    }

    // --- —É—Ç–∏–ª—ã/—Ö—ç—à/—Ç–∞—Ä–≥–µ—Ç
    const $=id=>document.getElementById(id);
    function randHex(n){const a=new Uint8Array(n);crypto.getRandomValues(a);return Array.from(a,x=>x.toString(16).padStart(2,'0')).join('')}
    function fmt(x,dp=4){const d=10n**18n;const i=x/d;const f=(x%d).toString().padStart(18,'0').slice(0,dp);return `${i}.${f}`}
    const k256=s=>ethers.keccak256(ethers.toUtf8Bytes(s));
    function compactToTarget(bits){const exp=(bits>>>24)&0xff;const mant=bits&0x007fffff;let t=BigInt(mant);const sh=8*(exp-3);return sh>=0?t*(1n<<BigInt(sh)):t/(1n<<BigInt(-sh))}
    function targetToCompact(t){let e=3,n=BigInt(t);while(n>0x007fffffn){n>>=8n;e++}const m=Number(n&0x007fffffn);return((e&0xff)<<24)|m}
    const curTarget=()=>compactToTarget(st.bits);

    // --- –ª–æ–≥ –ø–æ–ø—ã—Ç–æ–∫ (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ storage)
    let logBuf=[]; // [{html, ok}]
    function pushLog(html, ok){
      logBuf.push({html,ok}); if(logBuf.length>LOG_MAX) logBuf.shift();
    }

    // --- —Ä–µ–Ω–¥–µ—Ä
    let hrBase=Number(BASE_RATE/10n**14n)/100, hrJitter=0;
    function showHashrate(){ hrJitter+=(Math.random()-0.5)*0.1; hrJitter=Math.max(-0.5,Math.min(0.5,hrJitter)); const hr=Math.max(0,hrBase*(1+hrJitter/10)); $('sm-hr').textContent=`${hr.toFixed(2)} BGB/s`; }
    function render(){
      $('sm-addr').textContent = st.addr?`${st.addr.slice(0,6)}‚Ä¶${st.addr.slice(-4)}`:'‚Äî';
      $('sm-bits').textContent = '0x'+st.bits.toString(16);
      $('sm-height').textContent = st.height;
      $('sm-target').textContent = '0x'+curTarget().toString(16).slice(0,16)+'‚Ä¶';
      $('sm-acc').textContent = fmt(st.accrued,4);
      $('sm-last').textContent = st.height?st.chain.at(-1).hash.slice(0,10)+'‚Ä¶':'‚Äî';
      $('sm-retarget').textContent = RETARGET_INTERVAL - (st.height % RETARGET_INTERVAL || RETARGET_INTERVAL);
      $('sm-bar').style.width = Math.min(100, Number(st.accrued*100n/UNIT)) + '%';
      $('mp-count').textContent = mp.count; $('mp-fee').textContent=mp.fee.toFixed(2); $('mp-size').textContent=mp.size;
      $('sm-shares').textContent = st.shares||0;

      // —Ä–µ–Ω–¥–µ—Ä–∏–º –ª–æ–≥: –ø—É—Å—Ç—ã–µ (white) + –ø—Ä–∏–Ω—è—Ç—ã–µ (green)
      const list=$('sm-chain');
      list.innerHTML = [
        `<div class="empty">Mining log (white = try, green = accepted)</div>`,
        ...logBuf.slice(-MAX_VIEW).map(e=>`<div class="${e.ok?'ok':'empty'}">${e.html}</div>`).reverse()
      ].join('');

      showHashrate();
    }

    // --- –º–∞–π–Ω–∏–Ω–≥
    let mp={count:0,fee:0.0,size:0};
    function mineBatch(){
      const prev = st.height ? st.chain.at(-1).hash : GENESIS_PREV;
      const target = curTarget(); const nowSec=Math.floor(Date.now()/1000);

      for(let i=0;i<TRIES;i++){
        const nonce=randHex(8);
        const salt=randHex(4);       // —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–∏–ø—Ä–∞–≤–∫–∞
        const ctr=++st.ctr;          // –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
        const headerObj={ver:1,prev,time:nowSec,bits:st.bits,nonce,salt,ctr};
        const header=JSON.stringify(headerObj);
        const h=k256(header);
        const line=`${h} bits=0x${st.bits.toString(16)} nonce=${nonce} salt=${salt} ctr=${ctr} ‚Üê ${prev.slice(0,18)}‚Ä¶`;

        if(BigInt(h)<=target){
          // accepted
          const blk={idx:st.height+1,time:nowSec,bits:st.bits,nonce,prev,hash:h};
          st.chain.push(blk); st.height=blk.idx; st.shares=(st.shares||0)+1;
          if(st.chain.length>MAX_VIEW) st.chain=st.chain.slice(-MAX_VIEW);
          pushLog(line, true);
          $('sm-msg').textContent=`Mined block #${blk.idx}`;
          if(st.height % RETARGET_INTERVAL === 0) retarget();
          return true;
        }else{
          // –ø—É—Å—Ç–∞—è –ø–æ–ø—ã—Ç–∫–∞
          pushLog(line, false);
        }
      }
      return false;
    }

    function retarget(){
      if(st.height<RETARGET_INTERVAL) return;
      const from=st.chain.length-RETARGET_INTERVAL, first=st.chain[from], last=st.chain.at(-1);
      const actual=Math.max(1,last.time-first.time), span=BLOCK_TARGET_TIME*RETARGET_INTERVAL;
      const oldT=curTarget(); let newT= oldT*BigInt(actual)/BigInt(span);
      const minT=oldT/4n, maxT=oldT*4n; if(newT<minT)newT=minT; if(newT>maxT)newT=maxT;
      st.bits = targetToCompact(newT);
    }

    function tick(){
      if(!st.running) return;
      const now=Date.now(), dt=now-st.lastMs; if(dt<=0) return;
      st.accrued += BASE_RATE * BigInt(Math.floor(dt/1000));
      st.lastMs = now;

      mp.count=Math.max(0,Math.round(mp.count+(Math.random()*6-3)));
      mp.fee=Math.max(0.1,mp.fee+(Math.random()*0.2-0.1));
      mp.size=Math.max(0,Math.round(mp.size+(Math.random()*8-4)));

      mineBatch(); save(); render();
    }

    // --- –∫–Ω–æ–ø–∫–∏
    window.smConnect = async function(){
      const injected=(window.__bgb_provider||window.ethereum);
      if(!injected){ alert('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ MetaMask –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ Trust Wallet DApp.'); return; }
      try{
        if(injected.request){ await injected.request({ method:'eth_requestAccounts' }); }
        const p=new ethers.BrowserProvider(injected);
        const s=await p.getSigner(); const addr=await s.getAddress();
        loadFor(addr); st.addr=addr; save(); render();
      }catch(e){ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫'); }
    };
    window.smStart=function(){ st.running=true; st.lastMs=Date.now(); $('sm-msg').textContent='Mining‚Ä¶'; save(); render(); };
    window.smStop=function(){ st.running=false; $('sm-msg').textContent='Paused'; save(); render(); };
    window.smToggleChain=function(){ const el=$('sm-chain'); if(el.hasAttribute('hidden')) el.removeAttribute('hidden'); else el.setAttribute('hidden',''); render(); };

    // --- Claim
    window.smRequest = async function(){
      if(st.accrued<UNIT){ alert('–ù—É–∂–Ω–æ ‚â•30 BGB'); return; }
      const injected=(window.__bgb_provider||window.ethereum); if(!injected){ alert('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫'); return; }
      try{
        if(injected.request){ await injected.request({ method:'eth_requestAccounts' }); }
        const p=new ethers.BrowserProvider(injected), s=await p.getSigner(), addr=await s.getAddress();
        const payoutWei=st.accrued-(st.accrued%UNIT), amountBGB=fmt(payoutWei,4), last=st.chain.at(-1);
        const payload={address:addr,session:st.session,amountBGB,amountWei:payoutWei.toString(),height:st.height,lastBlock:last?last.hash:null,bits:st.bits,ts:new Date().toISOString()};
        const msg=`BGB Claim Request\nAddress: ${addr}\nSession: ${st.session}\nAmount: ${amountBGB} BGB\nHeight: ${st.height}\nBits: 0x${st.bits.toString(16)}\nLast: ${last?last.hash:'-'}\nTime: ${payload.ts}`;
        const sig=await s.signMessage(msg);
        const claim={...payload,signature:sig,message:msg};
        const modal=$('claim-modal'), pre=$('claim-json');
        if(modal&&pre){ pre.textContent=JSON.stringify(claim,null,2); modal.style.display='flex'; }
        else{ try{ await navigator.clipboard.writeText(JSON.stringify(claim,null,2)); }catch{} const share=`https://t.me/share/url?url=&text=${encodeURIComponent(msg+'\n\nSignature: '+sig)}`; window.open(share,'_blank','noopener,noreferrer'); }
      }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞'); }
    };
    window.copyClaim=async function(){ const pre=$('claim-json'); if(!pre) return; try{ await navigator.clipboard.writeText(pre.textContent); }catch{} };
    window.sendClaim=function(){ const pre=$('claim-json'); if(!pre) return; try{ const obj=JSON.parse(pre.textContent); const share=`https://t.me/share/url?url=&text=${encodeURIComponent(obj.message+'\n\nSignature: '+obj.signature)}`; window.open(share,'_blank','noopener,noreferrer'); }catch{} };
    window.closeClaim=function(){ const m=$('claim-modal'); if(m) m.style.display='none'; };

    // --- —Å—Ç–∞—Ä—Ç: –≥–æ—Å—Ç—å –≤—Å–µ–≥–¥–∞ —Å –Ω—É–ª—è
    loadFor(null);
    // –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ª–æ–≥–∞
    pushLog('Mined blocks will appear in green; tries in white.', false);
    render();
    setInterval(tick,500);
  })();
  </script>
</body>
</html>
