<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BGB Token ‚Ä¢ Mining</title>
<link rel="icon" href="logo.png"/>

<style>
:root{--accent:#e60000;--accent2:#cc0000;--ok:#00ff88;--muted:#9aa0a6}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:#0b0f14;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
.overlay{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:22px 14px;gap:12px}
h1{font-weight:800;font-size:44px;background:linear-gradient(90deg,#ff7a00,#ff3b3b);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.subtitle{color:#eaeaea}
.buttons{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
.btn{padding:12px 20px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;box-shadow:0 0 10px #e60000;cursor:pointer;text-decoration:none;display:inline-flex;gap:8px;align-items:center}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.btn:hover{background:var(--accent2);transform:translateY(-1px)}

.card{width:100%;max-width:1000px;background:#101418;border:1px solid #1f2531;border-radius:18px;padding:16px 18px;box-shadow:0 4px 30px rgba(0,0,0,.35)}
.hdr{font-weight:800;font-size:20px;margin-bottom:6px}

.row{font-size:14px;margin:2px 0;opacity:.95}
.tags{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
.tag{background:#131a23;border:1px solid #263040;color:#cbd5e1;padding:4px 8px;border-radius:999px;font-size:12px}
.tag.ok{border-color:#00ff88;color:#00ff88}

.acc{font-size:20px;margin:6px 0}
.bar{height:8px;background:#ffffff22;border-radius:999px;overflow:hidden}
#bar{height:100%;width:0%;background:#00ff88;transition:width .3s}

.btns{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px}
.btn-red{padding:10px 18px;font-size:15px;border-radius:10px;background:var(--accent);color:#fff;border:none;box-shadow:0 0 10px #e60000;cursor:pointer}
.btn-red[disabled]{opacity:.6;cursor:not-allowed}
.btn-red:hover{background:var(--accent2);transform:scale(1.05)}

.list{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;max-height:260px;overflow:auto;background:#0b0f14;border:1px solid #223043;border-radius:12px;padding:10px;margin-top:8px}
.list .ok{color:#00ff88}
.list .empty{color:#e5e7eb}

footer{margin:16px 0;color:#9aa0a6}

/* Modals */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50;padding:16px}
.modal .card{max-width:760px;width:100%;background:#0f1318;border:1px solid #293241;border-radius:14px;color:#e5e7eb;padding:16px}
.modal h3{margin:0 0 6px 0}
.modal p{margin:0 0 10px 0;color:#9aa4ad;font-size:13px}
.modal pre,.modal textarea{max-height:360px;min-height:120px;overflow:auto;background:#0b0f14;border-radius:10px;padding:12px;font-size:12px;color:#d1d5db;border:1px solid #2a3240;width:100%}
.modal .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
.modal .btn-red{padding:10px 16px;border-radius:10px;background:#e60000;border:none;color:#fff;cursor:pointer}
.modal .btn-red:hover{background:#cc0000}
.select{background:#0b0f14;border:1px solid #2a3240;color:#e5e7eb;border-radius:10px;padding:8px 10px}
.small{font-size:12px;color:#9aa0a6}

/* Admin panel */
.admin-toggle{display:none;position:sticky;top:10px;z-index:30}
.admin-card{display:none}
.admin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
.admin-box{background:#0d141c;border:1px solid #263040;border-radius:12px;padding:10px}
.admin-box h4{margin:0 0 6px 0;font-size:14px;color:#cbd5e1}
.admin-box label{display:flex;align-items:center;gap:8px;font-size:13px}
.admin-box input[type="text"], .admin-box input[type="number"]{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #2a3240;background:#0b0f14;color:#e5e7eb}
</style>
</head>
<body>
  <div class="overlay">
    <h1>BGB Token</h1>
    <div class="subtitle">üéÅ –ü–æ–ª—É—á–∏ <b>300 BGB</b> –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –Ω–∞ —Å–≤–æ–π –∫–æ—à–µ–ª—ë–∫</div>

    <div class="buttons">
      <a class="btn" href="https://bscscan.com/token/0xFeF80dbC16251862b82286864D77aFA08ECBcb5C" target="_blank" rel="noopener">üìÑ BSC Scan</a>
      <a class="btn" href="https://t.me/Makkan1985" target="_blank" rel="noopener">üí¨ Telegram</a>
      <button class="btn" onclick="openInMetaMask()">ü¶ä Open in MetaMask</button>
      <button class="btn" onclick="openInTrust()">üì± Open in Trust</button>
      <button class="btn" onclick="doConnect()">ü™ô Connect Wallet</button>
      <a class="btn" href="https://pancakeswap.finance/add/BNB/0xFeF80dbC16251862b82286864D77aFA08ECBcb5C?chain=bsc" target="_blank" rel="noopener">üíß Add Liquidity</a>
      <a class="btn" href="https://pancakeswap.finance/swap?chain=bsc&outputCurrency=0xFeF80dbC16251862b82286864D77aFA08ECBcb5C" target="_blank" rel="noopener">üõí Buy on PancakeSwap</a>
      <a class="btn" href="https://www.geckoterminal.com/ru/bsc/pools/0x5d498d6a3a36187e4c22c5628b0fbeb068fe405a" target="_blank" rel="noopener">üß≠ GeckoTerminal</a>
    </div>

    <div class="card">
      <div class="hdr">BGB Mining</div>

      <div class="row">Wallet: <span id="w">‚Äî</span></div>
      <div class="row">Hashrate: <span id="hr">‚Äî</span> ‚Ä¢ Difficulty bits: <span id="bits">‚Äî</span></div>
      <div class="row">Height: <span id="h">0</span> ‚Ä¢ Last block: <span id="last">‚Äî</span></div>
      <div class="row">Target: <span id="tgt">‚Äî</span> ‚Ä¢ Next retarget in: <span id="rtg">‚Äî</span></div>

      <div class="tags">
        <span class="tag">Active miners (tabs): <b id="tabs">1</b></span>
        <span class="tag">Global miners: <b id="gminers">0</b></span>
        <span class="tag">Blocks mined: <b id="bm">0</b></span>
        <span class="tag">Main pool: <b id="poolBalance">‚Äî</b></span>
        <span class="tag" id="legacyTag">Legacy: <b id="legacyBalance">‚Äî</b></span>
        <span class="tag">Available: <b id="available">0.0000 BGB</b></span>
        <span class="tag ok">Accepted: <b id="accp">0</b></span>
      </div>

      <div class="acc">Accrued: <span id="acc">0.0000</span> BGB</div>
      <div class="bar"><div id="bar"></div></div>
      <div class="row" id="msg">Status: ready</div>

      <div id="log" class="list"></div>

      <div class="btns">
        <button class="btn-red" onclick="doConnect()">Connect</button>
        <button class="btn-red" onclick="openInMetaMask()">Open in MetaMask</button>
        <button class="btn-red" onclick="openInTrust()">Open in Trust</button>
        <button class="btn-red" onclick="start()">Start</button>
        <button class="btn-red" onclick="stop()">Stop</button>
        <button class="btn-red" onclick="withdraw()" id="withdrawBtn" title="–í—ã–≤–µ—Å—Ç–∏ –Ω–∞ –∫–æ—à–µ–ª—ë–∫ (–≥–∞–∑ –ø–ª–∞—Ç–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)">Withdraw</button>
        <button class="btn-red" onclick="toggleLog()">Chain</button>
      </div>
    </div>

    <div class="card" style="max-width:1000px">
      <div class="hdr">–ü—É–ª—ã</div>
      <div class="row">Main (auto-withdraw): <code id="poolMainView"></code> <span id="claimCapTag" class="tag" style="margin-left:8px"></span></div>
      <div class="row" id="legacyRow">Legacy (hidden): <code id="poolLegacyView"></code> <span id="legacyEnabledTag" class="tag" style="margin-left:8px"></span></div>
      <div class="row small" id="legacyNote">–ö–Ω–æ–ø–∫–∞ –¥–ª—è Legacy —Å–∫—Ä—ã—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤—ã–ø–ª–∞—Ç—ã –∏–¥—É—Ç —á–µ—Ä–µ–∑ Main.</div>
      <div class="row">Admin: <code id="adminAddrView"></code></div>

      <!-- Admin toggle (–≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É) -->
      <div class="admin-toggle">
        <button class="btn" id="adminToggleBtn" onclick="toggleAdminPanel()">‚öôÔ∏è Admin</button>
      </div>
      <div id="adminPanel" class="admin-card">
        <div class="admin-grid">
          <div class="admin-box">
            <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Legacy</h4>
            <label><input type="checkbox" id="chkLegacyVisible"> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å Legacy –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</label>
            <label><input type="checkbox" id="chkLegacyEnabled"> –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—ã–ø–ª–∞—Ç—ã –∏–∑ Legacy (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)</label>
            <button class="btn-red" style="margin-top:8px" onclick="adminSaveConfig()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>

          <div class="admin-box">
            <h4>–ú–∏–≥—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤</h4>
            <label>–°—É–º–º–∞ (BGB)<input type="number" id="migrateAmt" min="0" step="0.0001" placeholder="100.0"></label>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
              <button class="btn-red" onclick="adminMigrate('legacy','main')">Legacy ‚Üí Main</button>
              <button class="btn-red" onclick="adminMigrate('main','legacy')">Main ‚Üí Legacy</button>
            </div>
            <div class="small" style="margin-top:6px">–ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ rescueERC20/execute –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ.</div>
          </div>

          <div class="admin-box">
            <h4>–í–∞—É—á–µ—Ä (–ø–æ–¥–ø–∏—Å—å)</h4>
            <label>–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è<input type="text" id="vTo" placeholder="0x..."/></label>
            <label>–°—É–º–º–∞ (BGB)<input type="number" id="vAmt" min="0" step="0.0001" placeholder="100.0"/></label>
            <label>–°—Ä–æ–∫ (–º–∏–Ω)<input type="number" id="vMins" min="1" step="1" value="60"/></label>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
              <button class="btn-red" onclick="adminGenerateVoucher()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn-red" onclick="adminCopyVoucher()">Copy</button>
            </div>
            <textarea id="voucherOut" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è JSON —Å –ø–æ–¥–ø–∏—Å—å—é" style="margin-top:8px"></textarea>
          </div>
        </div>
      </div>
    </div>

    <footer>¬© 2025 BGB Token</footer>
  </div>

  <!-- Claim (payload for admin, fallback) -->
  <div id="claim" class="modal" role="dialog" aria-modal="true">
    <div class="card">
      <h3>Claim Payload</h3>
      <p>–ï—Å–ª–∏ —Å–∞–º–æ–≤—ã–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ Telegram.</p>
      <pre id="claimText">{}</pre>
      <div class="row" style="justify-content:space-between">
        <div id="payoutSourceWrap" style="display:none">
          <label class="small">Payout source:</label>
          <select id="payoutSource" class="select"></select>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-red" onclick="copyClaim()">Copy</button>
          <button class="btn-red" onclick="openTG()">Open Telegram</button>
          <button class="btn-red" id="adminSendBtn" style="display:none" onclick="adminPayoutFromModal()">Send (Admin)</button>
          <button class="btn-red" onclick="closeClaim()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: –ø–æ–¥–ø–∏—Å—å –≤–∞—É—á–µ—Ä–∞ –≤—Ä—É—á–Ω—É—é (–µ—Å–ª–∏ –Ω–µ—Ç –±—ç–∫–∞) -->
  <div id="sigModal" class="modal" role="dialog" aria-modal="true">
    <div class="card">
      <h3>–í—Å—Ç–∞–≤—å—Ç–µ –ø–æ–¥–ø–∏—Å—å –≤–∞—É—á–µ—Ä–∞</h3>
      <p>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–∞—ë—Ç –≤–∞–º –ø–æ–¥–ø–∏—Å—å (0x‚Ä¶). –í—Å—Ç–∞–≤—å—Ç–µ –µ—ë –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.</p>
      <textarea id="sigInput" placeholder="0x‚Ä¶"></textarea>
      <div class="row">
        <button class="btn-red" onclick="useSignatureFromModal()">Use signature</button>
        <button class="btn-red" onclick="closeSigModal()">Close</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js" crossorigin="anonymous"></script>

  <!-- Firebase presence + config (legacyVisible/legacyEnabled) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, onDisconnect, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    const firebaseConfig = { apiKey: "AIzaSyAxVR12YVssinbr-dfZY8Wozjnou0TSpCM", authDomain: "bgb-miner.firebaseapp.com", projectId: "bgb-miner", storageBucket: "bgb-miner.firebasestorage.app", messagingSenderId: "1071946045783", appId: "1:1071946045783:web:3d91a09f70ed6d1e714612", measurementId: "G-53EZW3BDMX", databaseURL: "https://bgb-miner-default-rtdb.firebaseio.com" };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    window.__bgb_firebase = { db, ref, onValue, set, onDisconnect, serverTimestamp, runTransaction };
  </script>

  <!-- Main logic -->
  <script>
  // ====== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
  const MIN_PAYOUT_BGB = 100n;                         // –ª–∏–º–∏—Ç –≤—ã–≤–æ–¥–∞
  const UNIT           = MIN_PAYOUT_BGB * 10n**18n;
  const BLOCK_REWARD   = 1n * 10n**18n;                // 1 BGB/–±–ª–æ–∫ (—Å–∏–º—É–ª—è—Ü–∏—è)
  const TRIES=128, LOG_MAX=600, VIEW_MAX=260;
  const BLOCK_TARGET_TIME=10, RETARGET_INTERVAL=20;
  const GENESIS='0xf49bd1cb89367c32e3e3814b66ce02a181043f63f9af3dc1e9b5686faf15742d';
  const HR_UI = 5.00;

  // –ê–¥—Ä–µ—Å–∞
  const TOKEN_ADDRESS = "0xFeF80dbC16251862b82286864D77aFA08ECBcb5C";
  const MAIN_POOL_ADDRESS   = "0x398c9549413ccffe72a86d9ee937cb8122b7100a"; // –Ω–æ–≤—ã–π –ø—É–ª (verified)
  const LEGACY_POOL_ADDRESS = "0x01C08edE0510Fd2F72f9e0C7056380f54Eb443e6"; // —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å 150k
  const ADMIN_ADDRESS = "0xd2ac7f75dbad4aaa23e7e43f7aF03Ca4B05DB957";
  const BSC_CHAIN_ID_HEX = "0x38";

  const ADDR = { main: MAIN_POOL_ADDRESS, legacy: LEGACY_POOL_ADDRESS };

  // ABI
  const TOKEN_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function decimals() view returns (uint8)",
    "function transfer(address to, uint256 amount) returns (bool)"
  ];
  const POOL_ABI = [
    "function owner() view returns (address)",
    "function rescueERC20(address token, address to, uint256 amount)",
    "function execute(address to, uint256 value, bytes data) returns (bytes)",
    "function nonces(address) view returns (uint256)",
    "function claimSigned(address to,uint256 amount,uint256 deadline,uint8 v,bytes32 r,bytes32 s)"
  ];

  // Helpers
  const $=id=>document.getElementById(id);
  const k256=s=>ethers.keccak256(ethers.toUtf8Bytes(s));
  function randHex(n){const a=new Uint8Array(n);crypto.getRandomValues(a);return Array.from(a,x=>x.toString(16).padStart(2,'0')).join('')}
  function fmtB(x,dp=4){const d=10n**18n;const i=x/d;const f=(x%d).toString().padStart(18,'0').slice(0,dp);return `${i}.${f}`}
  function fmtUnitsBI(bi,dec=18,dp=4){const d=10n**BigInt(dec);const i=bi/d;const f=(bi%d).toString().padStart(dec,'0').slice(0,dp);return `${i}.${f}`}
  function compactToTarget(bits){const exp=(bits>>>24)&0xff;const mant=bits&0x007fffff;let t=BigInt(mant);const sh=8*(exp-3);return sh>=0?t*(1n<<BigInt(sh)):t/(1n<<BigInt(-sh))}
  function targetToCompact(t){let e=3,n=BigInt(t);while(n>0x007fffffn){n>>=8n;e++}const m=Number(n&0x007fffffn);return((e&0xff)<<24)|m}

  // State
  const KEY='bgb_miner_ui_v13';
  const DEF=()=>({addr:null,running:false,lastMs:Date.now(),accrued:0n,bits:0x1f00ffff,height:0,chain:[],shares:0,ctr:0,session:randHex(16)});
  let S=DEF(), logBuf=[];
  let LEGACY_ENABLED=false, LEGACY_VISIBLE=false;

  const seen=new Set(); const queue=[];
  function remember(hash){ if(seen.has(hash)) return false; seen.add(hash); queue.push(hash); if(queue.length>4000){ const old=queue.shift(); seen.delete(old);} return true; }

  function save(){ try{ localStorage.setItem(KEY+':'+(S.addr||'guest'), JSON.stringify({...S,accrued:S.accrued.toString()})); }catch{} }
  function load(addr){
    try{
      const raw=localStorage.getItem(KEY+':'+(addr||'guest'));  // FIX: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä addr
      if(!raw){ S=DEF(); S.addr=addr||null; return;}
      const p=JSON.parse(raw);
      S={...DEF(),...p}; if(typeof S.accrued==='string') S.accrued=BigInt(S.accrued); S.addr=addr||null;
    }catch{ S=DEF(); S.addr=addr||null; }
  }

  // Tabs counter
  const TAB_PREFIX='BGB_TAB_'; const TAB_ID=randHex(6);
  function heartbeat(){ try{ localStorage.setItem(TAB_PREFIX+TAB_ID, String(Date.now())); }catch{} }
  function countTabs(){ try{ const now=Date.now(), ttl=9000; let n=0; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && k.startsWith(TAB_PREFIX)){ const t=Number(localStorage.getItem(k)); if(now-t < ttl) n++; } } $('tabs').textContent=n||1; }catch{ $('tabs').textContent='1'; } }
  setInterval(()=>{ heartbeat(); countTabs(); },3000); heartbeat(); countTabs();

  // Firebase presence + config
  function initFirebasePresence(){
    if (!window.__bgb_firebase || !S.addr) return;
    const { db, ref, onValue, set, onDisconnect, serverTimestamp } = window.__bgb_firebase;
    const clientId = (S.addr || 'guest') + '_' + TAB_ID;
    const presenceRef = ref(db, 'presence/'+clientId);
    set(presenceRef, { ts: serverTimestamp(), ua: navigator.userAgent || '' }).catch(()=>{});
    try { onDisconnect(presenceRef).remove(); } catch {}

    // —Å—á—ë—Ç—á–∏–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –º–∞–π–Ω–µ—Ä–æ–≤ + –±–ª–æ–∫–æ–≤
    onValue(ref(db, 'presence'), (snap) => { $('gminers').textContent = snap.exists() ? (snap.size || Object.keys(snap.val()||{}).length) : 0; });
    onValue(ref(db, 'stats/blocksMined'), (snap) => { $('bm').textContent = snap.exists() ? snap.val() : 0; });

    // —Ñ–ª–∞–≥–∏ Legacy
    onValue(ref(db, 'config/legacyEnabled'), (snap) => { LEGACY_ENABLED = !!snap.val(); render(); });
    onValue(ref(db, 'config/legacyVisible'), (snap) => { LEGACY_VISIBLE = !!snap.val(); render(); });
  }

  // –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á—ë—Ç—á–∏–∫–∞ –±–ª–æ–∫–æ–≤ (–¥–æ–±–∞–≤–ª–µ–Ω–æ)
  async function incBlocksMined(){
    try{
      const { db, ref, runTransaction } = window.__bgb_firebase || {};
      if(!db) return;
      await runTransaction(ref(db, 'stats/blocksMined'), (v)=> (v||0)+1);
    }catch(e){}
  }

  // UI / capabilities
  let hrJ=0;
  const CAPS={ main:{isContract:false, claim:false, owner:null}, legacy:{isContract:false, claim:false, owner:null} };

  function render(){
    $('w').textContent=S.addr?S.addr.slice(0,6)+'‚Ä¶'+S.addr.slice(-4):'‚Äî';
    $('poolMainView').textContent=ADDR.main;
    $('poolLegacyView').textContent=ADDR.legacy;
    $('adminAddrView').textContent=ADMIN_ADDRESS;

    const ct=$('claimCapTag'); ct.textContent = CAPS.main.claim ? 'claimSigned: OK' : 'claimSigned: N/A'; ct.className = 'tag ' + (CAPS.main.claim?'ok':'');

    const lt=$('legacyEnabledTag'); lt.textContent = LEGACY_ENABLED ? 'legacy payouts: enabled' : 'legacy payouts: hidden'; lt.className = 'tag ' + (LEGACY_ENABLED?'ok':'');

    const legacyRow=$('legacyRow'), legacyTag=$('legacyTag'), legacyNote=$('legacyNote');
    const admin = isAdminWalletSync();
    const visibleLegacy = admin || LEGACY_VISIBLE; // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ
    [legacyRow, legacyTag, legacyNote].forEach(el=>{ if(el) el.style.display = visibleLegacy? 'block' : 'none'; });

    // admin controls visibility
    const adminBtn = document.getElementById('adminToggleBtn');
    const adminWrap = document.querySelector('.admin-toggle');
    if(adminBtn && adminWrap) adminWrap.style.display = admin? 'block' : 'none';

    // prefill admin checkboxes with config
    const chkV=$('chkLegacyVisible'), chkE=$('chkLegacyEnabled');
    if(chkV) chkV.checked = !!LEGACY_VISIBLE; if(chkE) chkE.checked = !!LEGACY_ENABLED;

    hrJ+=(Math.random()-0.5)*0.1; hrJ=Math.max(-0.5,Math.min(0.5,hrJ));
    const hr=Math.max(0,HR_UI*(1+hrJ/10)).toFixed(2);
    $('hr').textContent=`${hr} H/s`;
    $('bits').textContent='0x'+S.bits.toString(16);
    $('h').textContent=S.height;
    $('last').textContent=S.height?S.chain.at(-1).hash.slice(0,10)+'‚Ä¶':'‚Äî';
    const tgt=compactToTarget(S.bits); $('tgt').textContent='0x'+tgt.toString(16).slice(0,16)+'‚Ä¶';
    $('rtg').textContent=RETARGET_INTERVAL - (S.height % RETARGET_INTERVAL || RETARGET_INTERVAL);
    $('acc').textContent=fmtB(S.accrued,4);
    $('available').textContent=fmtB(S.accrued,4)+' BGB';
    $('bar').style.width=Math.min(100,Number(S.accrued*100n/UNIT))+'%';
    $('accp').textContent=S.shares||0;

    // –º–æ–¥–∞–ª–∫–∞: –≤—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –≤—ã–ø–ª–∞—Ç –∞–¥–º–∏–Ω—É
    const adminBtn2 = $('adminSendBtn');
    if(adminBtn2) adminBtn2.style.display = admin ? 'inline-block' : 'none';
    const wrap = $('payoutSourceWrap');
    if (wrap) {
      wrap.style.display = admin ? 'block' : 'none';
      if (admin) fillPayoutSourceSelect();
    }

    const log=$('log');
    log.innerHTML=[ `<div class="empty">Mining log (white = try, green = accepted)</div>`, ...logBuf.slice(-VIEW_MAX).map(e=>`<div class="${e.ok?'ok':'empty'}">${e.html}</div>`).reverse() ].join('');
  }

  function fillPayoutSourceSelect(){
    const sel = $('payoutSource'); if(!sel) return; sel.innerHTML='';
    sel.add(new Option('Main pool','main',true,true));
    if(LEGACY_ENABLED) sel.add(new Option('Legacy pool','legacy'));
  }

  function retarget(){ if(S.height<RETARGET_INTERVAL) return; const from=S.chain.length-RETARGET_INTERVAL, first=S.chain[from], last=S.chain.at(-1); const actual=Math.max(1,last.time-first.time), span=BLOCK_TARGET_TIME*RETARGET_INTERVAL; const oldT=compactToTarget(S.bits); let newT=oldT*BigInt(actual)/BigInt(span); const minT=oldT/4n,maxT=oldT*4n; if(newT<minT)newT=minT; if(newT>maxT)newT=maxT; S.bits=targetToCompact(newT); }

  function pushLine(html,ok){ logBuf.push({html,ok}); if(logBuf.length>LOG_MAX) logBuf.shift(); }

  function mineBatch(){ const prev=S.height?S.chain.at(-1).hash:GENESIS; const tgt=compactToTarget(S.bits), now=Math.floor(Date.now()/1000); for(let i=0;i<TRIES;i++){ const nonce=randHex(8), salt=randHex(4), ctr=++S.ctr; const header=JSON.stringify({ver:1,prev,time:now,bits:S.bits,nonce,salt,ctr}); const h=k256(header); if(!remember(h)) { i--; continue; } const line=`${h} bits=0x${S.bits.toString(16)} nonce=${nonce} salt=${salt} ctr=${ctr} ‚Üê ${prev.slice(0,18)}‚Ä¶`; if(BigInt(h)<=tgt){ const blk={idx:S.height+1,time:now,bits:S.bits,nonce,prev,hash:h}; S.chain.push(blk); S.height=blk.idx; S.shares=(S.shares||0)+1; S.accrued += BLOCK_REWARD; pushLine(`${line}  (+1 BGB)`,true); $('msg').textContent=`Mined block #${blk.idx} (+1 BGB)`; if(S.height % RETARGET_INTERVAL===0) retarget(); incBlocksMined(); save(); render(); if (CAPS.main.claim && S.accrued>=UNIT) setTimeout(()=>{ try{ withdraw(); }catch{} }, 250); return; } else { pushLine(line,false);} } }

  function tick(){ if(!S.running) return; mineBatch(); save(); render(); }

  // wallet buttons
  function openInMetaMask(){ window.location.href='https://metamask.app.link/dapp/'+location.host+location.pathname; }
  function openInTrust(){ const dappUrl=encodeURIComponent(location.href); window.location.href=`https://link.trustwallet.com/open_url?source=dapp&url=${dappUrl}`; }
  async function doConnect(){ try{ const injected=(window.__bgb_provider||window.ethereum); if(!injected){ alert('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ MetaMask –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ Trust Wallet DApp.'); return; } if(injected.request){ await injected.request({method:'eth_requestAccounts'}); } const p=new ethers.BrowserProvider(injected); const s=await p.getSigner(); const addr=await s.getAddress(); load(addr); S.addr=addr; save(); render(); initFirebasePresence(); await detectCaps('main'); await detectCaps('legacy'); }catch(e){ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫'); } }
  function start(){ if(!S.addr){ alert('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ (Connect)'); return; } S.running=true; S.lastMs=Date.now(); $('msg').textContent='Mining‚Ä¶'; }
  function stop(){ S.running=false; $('msg').textContent='Paused'; }
  function toggleLog(){ const el=$('log'); el.style.display=(el.style.display==='none'?'block':'none'); }

  // Fallback payload (–¥–ª—è Telegram)
  function requestPayout(){ const pay=S.accrued-(S.accrued%UNIT), last=S.chain.at(-1); const payload={ address:S.addr, session:S.session, amountBGB:(Number(pay)/1e18).toFixed(3), amountWei:pay.toString(), height:S.height, lastBlock:last?last.hash:null, bits:S.bits, fromPool: ADDR.main, token: TOKEN_ADDRESS, poolBalance: $('poolBalance').textContent || '‚Äî', ts:new Date().toISOString() }; $('claimText').textContent=JSON.stringify(payload,null,2); $('claim').style.display='flex'; }
  async function copyClaim(){ try{ await navigator.clipboard.writeText($('claimText').textContent); alert('Copied'); }catch{} }
  function openTG(){ const txt=encodeURIComponent(`–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É BGB:\n\n${$('claimText').textContent}`); window.open('https://t.me/share/url?url=&text='+txt,'_blank','noopener,noreferrer'); }
  function closeClaim(){ $('claim').style.display='none'; }

  // Admin helpers
  function isAdminWalletSync(){ const addr=(S.addr||'').toLowerCase(); if(!addr) return false; if(addr===ADMIN_ADDRESS.toLowerCase()) return true; if(CAPS.main.owner && addr===CAPS.main.owner.toLowerCase()) return true; return false; }
  async function ensureBSC(){ if(!window.ethereum) return; const cid=await window.ethereum.request({ method:'eth_chainId' }); if(cid!==BSC_CHAIN_ID_HEX){ await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BSC_CHAIN_ID_HEX }] }).catch(()=>{}); } }

  async function detectCaps(which){ const addr = ADDR[which]; try{ const provider = getReadProvider(); const code = await provider.getCode(addr); CAPS[which].isContract = !!code && code !== '0x'; if(CAPS[which].isContract){ try{ const c = new ethers.Contract(addr, POOL_ABI, provider); CAPS[which].owner = await c.owner().catch(()=>null); try{ await c.nonces('0x0000000000000000000000000000000000000000'); CAPS[which].claim = true; }catch{ CAPS[which].claim = false; } }catch{ CAPS[which].claim=false; CAPS[which].owner=null; } } else { CAPS[which].claim=false; CAPS[which].owner=null; } }catch(e){ CAPS[which].isContract=false; CAPS[which].claim=false; CAPS[which].owner=null; } render(); loadBothBalances(); }

  function toggleAdminPanel(){ const card = document.getElementById('adminPanel'); if(!card) return; card.style.display = (card.style.display==='block') ? 'none' : 'block'; }

  async function adminSaveConfig(){ try{ if(!isAdminWalletSync()) { alert('Admin only'); return; } const { db, ref, set } = window.__bgb_firebase || {}; if(!db) { alert('Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; } const vis = !!document.getElementById('chkLegacyVisible').checked; const en  = !!document.getElementById('chkLegacyEnabled').checked; await set(ref(db,'config/legacyVisible'), vis); await set(ref(db,'config/legacyEnabled'), en); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); }catch(e){ alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏'); console.error(e); } }

  async function adminMigrate(fromKey, toKey){ try{ if(!isAdminWalletSync()) { alert('Admin only'); return; } const amtStr = (document.getElementById('migrateAmt').value||'').trim(); if(!amtStr) { alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É'); return; } const amount = BigInt(Math.floor(Number(amtStr)*1e18)); if(amount<=0n) { alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞'); return; } const fromAddr = ADDR[fromKey], toAddr = ADDR[toKey]; const provider=new ethers.BrowserProvider(window.ethereum); const signer=await provider.getSigner(); const fromCaps = CAPS[fromKey]; if(!fromCaps.isContract){ alert('–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ (–Ω—É–∂–µ–Ω –∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å rescue/execute).'); return; } const pool=new ethers.Contract(fromAddr, POOL_ABI, signer); const tokenIF=new ethers.Interface(["function transfer(address,uint256) returns (bool)"]); const calldata=tokenIF.encodeFunctionData('transfer',[toAddr, amount]); let tx; try{ tx=await pool.rescueERC20(TOKEN_ADDRESS, toAddr, amount); }catch(e1){ try{ tx=await pool.execute(TOKEN_ADDRESS, 0, calldata); }catch(e2){ console.error('migrate failed',{e1,e2}); alert('–ö–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç rescue/execute ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.'); return; } } $('msg').textContent='Migrating: '+tx.hash; const rc=await tx.wait(); $('msg').textContent='Migration confirmed in block '+rc.blockNumber; await loadBothBalances(); alert('–ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: '+tx.hash); }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: '+(e?.shortMessage||e?.message||e)); } }

  async function adminGenerateVoucher(){ try{ if(!isAdminWalletSync()) { alert('Admin only'); return; } await ensureBSC(); const to = (document.getElementById('vTo').value||'').trim(); const amt = Number(document.getElementById('vAmt').value||'0'); const mins = Math.max(1, Number(document.getElementById('vMins').value||'60')); if(!to || !to.startsWith('0x')){ alert('–ê–¥—Ä–µ—Å 0x‚Ä¶'); return; } if(!(amt>0)) { alert('–°—É–º–º–∞ > 0'); return; } const amountWei = BigInt(Math.floor(amt*1e18)); const provider=new ethers.BrowserProvider(window.ethereum); const signer=await provider.getSigner(); const pool=new ethers.Contract(ADDR.main, ["function nonces(address) view returns (uint256)"], provider); const nonce=await pool.nonces(to); const deadline=Math.floor(Date.now()/1000)+mins*60; const domain={ name:'BGBMiner', version:'1', chainId:56, verifyingContract:ADDR.main }; const types={ Claim:[ {name:'to',type:'address'},{name:'amount',type:'uint256'},{name:'nonce',type:'uint256'},{name:'deadline',type:'uint256'} ]}; const value={ to, amount: amountWei.toString(), nonce: Number(nonce), deadline }; const sig = await signer.signTypedData(domain, types, value); const out = { domain, types, value, sig }; document.getElementById('voucherOut').value = JSON.stringify(out, null, 2); alert('–í–∞—É—á–µ—Ä –≥–æ—Ç–æ–≤ ‚Äî –º–æ–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏: '+(e?.shortMessage||e?.message||e)); } }

  async function adminCopyVoucher(){ try{ const el=document.getElementById('voucherOut'); if(!el || !el.value){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'); return; } await navigator.clipboard.writeText(el.value); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); }catch(e){ console.error(e); }}

  // Admin payout (–∏—Å—Ç–æ—á–Ω–∏–∫ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∞–¥–º–∏–Ω–æ–º)
  async function adminPayoutFromModal(){ try{ if(!isAdminWalletSync()){ alert('Admin only'); return; } await ensureBSC(); const txt=$('claimText').textContent.trim(); if(!txt){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏'); return; } let data; try{ data=JSON.parse(txt);}catch{ alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞—è–≤–∫–∏'); return; } const to=(data.address||'').trim(); const amountWeiStr=(data.amountWei||'').trim(); if(!to || !amountWeiStr){ alert('–ù–µ—Ç –∞–¥—Ä–µ—Å–∞/—Å—É–º–º—ã'); return; } const srcSel=$('payoutSource'); const source=(srcSel && srcSel.value)||'main'; const poolAddr = ADDR[source]; const provider=new ethers.BrowserProvider(window.ethereum); const signer=await provider.getSigner(); if(!CAPS[source].isContract){ const token=new ethers.Contract(TOKEN_ADDRESS,["function transfer(address,uint256) returns (bool)"], signer); const tx=await token.transfer(to, BigInt(amountWeiStr)); $('msg').textContent='Sending payout tx: '+tx.hash; const rcpt=await tx.wait(); $('msg').textContent='Payout confirmed in block '+rcpt.blockNumber; await loadBothBalances(); alert('–í—ã–ø–ª–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: '+tx.hash); closeClaim(); return; } const pool=new ethers.Contract(poolAddr, POOL_ABI, signer); const tokenIF=new ethers.Interface(["function transfer(address,uint256) returns (bool)"]); const calldata=tokenIF.encodeFunctionData('transfer',[to,BigInt(amountWeiStr)]); let tx; try{ tx=await pool.rescueERC20(TOKEN_ADDRESS,to,BigInt(amountWeiStr)); }catch(e1){ try{ tx=await pool.execute(TOKEN_ADDRESS,0,calldata);}catch(e2){ console.error('payout failed',{e1,e2}); alert('–ö–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç rescue/execute.'); return; } } $('msg').textContent='Sending payout tx: '+tx.hash; const rcpt=await tx.wait(); $('msg').textContent='Payout confirmed in block '+rcpt.blockNumber; await loadBothBalances(); alert('–í—ã–ø–ª–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: '+tx.hash); closeClaim(); }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ –≤—ã–ø–ª–∞—Ç—ã: '+(e?.shortMessage||e?.message||e)); } }

  // Unified WITHDRAW (—Ç–æ–ª—å–∫–æ MAIN)
  let _pendingVoucher=null;
  function openSigModal(){ $('sigModal').style.display='flex'; }
  function closeSigModal(){ $('sigModal').style.display='none'; }

  async function withdraw(){ if(!S.addr){ alert('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫'); return; } if(S.accrued < UNIT){ alert('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º '+String(MIN_PAYOUT_BGB)+' BGB'); return; } if(CAPS.main.claim){ await claimToWallet(); } else { requestPayout(); alert('–°–∞–º–æ–≤—ã–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ MAIN –ø—É–ª–∞.'); } }

  async function claimToWallet(){ try{ await ensureBSC(); const provider=new ethers.BrowserProvider(window.ethereum); const signer=await provider.getSigner(); const pool=new ethers.Contract(ADDR.main, POOL_ABI, signer); const pay=S.accrued-(S.accrued%UNIT); const nonce=await pool.nonces(S.addr); const deadline=Math.floor(Date.now()/1000)+3600; const value={ to:S.addr, amount: pay.toString(), nonce: Number(nonce), deadline }; _pendingVoucher=value; try{ const domain={ name:'BGBMiner', version:'1', chainId:56, verifyingContract:ADDR.main }; const types={ Claim:[ {name:'to',type:'address'},{name:'amount',type:'uint256'},{name:'nonce',type:'uint256'},{name:'deadline',type:'uint256'} ]}; const res=await fetch('/api/bgb/claim-sign',{ method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({domain,types,value}) }); if(!res.ok) throw new Error('no backend'); const {sig}=await res.json(); await submitClaimWithSig(sig,pool,value); return; }catch{ openSigModal(); } }catch(e){ console.error(e); alert('Claim error: '+(e?.shortMessage||e?.message||e)); } }

  async function useSignatureFromModal(){ try{ const sig=($('sigInput').value||'').trim(); if(!sig || !sig.startsWith('0x')){ alert('–í—Å—Ç–∞–≤—å—Ç–µ –ø–æ–¥–ø–∏—Å—å 0x‚Ä¶'); return;} const provider=new ethers.BrowserProvider(window.ethereum); const signer=await provider.getSigner(); const pool=new ethers.Contract(ADDR.main, POOL_ABI, signer); await submitClaimWithSig(sig,pool,_pendingVoucher); closeSigModal(); }catch(e){ console.error(e); alert('Signature/claim error: '+(e?.shortMessage||e?.message||e)); } }

  async function submitClaimWithSig(sig,pool,value){ if(!value){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤–∞—É—á–µ—Ä–∞'); return;} const {v,r,s}=ethers.Signature.from(sig); const tx=await pool.claimSigned(value.to,value.amount,value.deadline,v,r,s); $('msg').textContent='Submitting claim tx: '+tx.hash; const rc=await tx.wait(); $('msg').textContent='Claim confirmed in block '+rc.blockNumber; S.accrued -= BigInt(value.amount); save(); render(); loadBothBalances(); alert('–í—ã–ø–ª–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: '+tx.hash); }

  // –ë–∞–ª–∞–Ω—Å—ã
  let _tokenDecimals=18;
  function getReadProvider(){ if(window.ethereum){ try{ return new ethers.BrowserProvider(window.ethereum);}catch{} } return new ethers.JsonRpcProvider('https://bsc-dataseed.binance.org/'); }
  async function loadBothBalances(){ try{ const provider=getReadProvider(); const sp=(provider.getSigner? await provider.getSigner().catch(()=>provider):provider); const token=new ethers.Contract(TOKEN_ADDRESS,["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)"], sp); try{ _tokenDecimals=Number(await token.decimals()); }catch{} const [bMain,bLegacy]=await Promise.all([ token.balanceOf(ADDR.main).catch(()=>0n), token.balanceOf(ADDR.legacy).catch(()=>0n) ]); $('poolBalance').textContent=fmtUnitsBI(bMain,_tokenDecimals)+' BGB'; $('legacyBalance').textContent=fmtUnitsBI(bLegacy,_tokenDecimals)+' BGB'; }catch(e){ console.error('balance error:',e); $('poolBalance').textContent='‚Äî'; $('legacyBalance').textContent='‚Äî'; } }

  // export
  Object.assign(window,{ openInMetaMask, openInTrust, doConnect, start, stop, toggleLog, withdraw, copyClaim, openTG, closeClaim, adminPayoutFromModal, useSignatureFromModal, closeSigModal, toggleAdminPanel, adminSaveConfig, adminMigrate, adminGenerateVoucher, adminCopyVoucher });

  // boot
  load(null); pushLine('Mining log (white = try, green = accepted)',false); render(); setInterval(tick,500);
  if(window.ethereum){ window.ethereum.request({method:'eth_accounts'}).then(acc=>{ if(acc && acc[0]){ load(acc[0]); S.addr=acc[0]; render(); initFirebasePresence(); detectCaps('main'); detectCaps('legacy'); } }).catch(()=>{}); window.ethereum.on?.('accountsChanged',()=>{ if(S.addr){ doConnect(); } }); window.ethereum.on?.('chainChanged',()=>{ loadBothBalances(); detectCaps('main'); detectCaps('legacy'); }); }
  loadBothBalances(); detectCaps('main'); detectCaps('legacy'); setInterval(loadBothBalances,30000);
  </script>
</body>
</html>
