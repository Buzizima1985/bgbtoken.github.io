<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BGB Token ‚Ä¢ Mining</title>
<link rel="icon" href="logo.png"/>

<style>
:root{--accent:#e60000;--accent2:#cc0000;--ok:#00ff88;--muted:#9aa0a6}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:#0b0f14;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
.overlay{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:22px 14px;gap:12px}
h1{font-weight:800;font-size:44px;background:linear-gradient(90deg,#ff7a00,#ff3b3b);
     -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.subtitle{color:#eaeaea}
.buttons{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
.btn{padding:12px 20px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;
     box-shadow:0 0 10px #e60000;cursor:pointer;text-decoration:none;display:inline-flex;gap:8px;align-items:center}
.btn:hover{background:var(--accent2);transform:translateY(-1px)}

.card{width:100%;max-width:980px;background:#101418;border:1px solid #1f2531;border-radius:18px;
      padding:16px 18px;box-shadow:0 4px 30px rgba(0,0,0,.35)}
.hdr{font-weight:800;font-size:20px;margin-bottom:6px}

.row{font-size:14px;margin:2px 0;opacity:.95}
.tags{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
.tag{background:#131a23;border:1px solid #263040;color:#cbd5e1;padding:4px 8px;border-radius:999px;font-size:12px}
.tag.ok{border-color:#00ff88;color:#00ff88}

.acc{font-size:20px;margin:6px 0}
.bar{height:8px;background:#ffffff22;border-radius:999px;overflow:hidden}
#bar{height:100%;width:0%;background:#00ff88;transition:width .3s}

.btns{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px}
.btn-red{padding:10px 18px;font-size:15px;border-radius:10px;background:var(--accent);color:#fff;border:none;
         box-shadow:0 0 10px #e60000;cursor:pointer}
.btn-red:hover{background:var(--accent2);transform:scale(1.05)}

.list{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;max-height:260px;overflow:auto;
      background:#0b0f14;border:1px solid #223043;border-radius:12px;padding:10px;margin-top:8px}
.list .ok{color:#00ff88}
.list .empty{color:#e5e7eb}

footer{margin:16px 0;color:#9aa0a6}

/* Claim modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50;padding:16px}
.modal .card{max-width:720px;width:100%;background:#0f1318;border:1px solid #293241;border-radius:14px;color:#e5e7eb;padding:16px}
.modal h3{margin:0 0 6px 0}
.modal p{margin:0 0 10px 0;color:#9aa4ad;font-size:13px}
.modal pre{max-height:360px;overflow:auto;background:#0b0f14;border-radius:10px;padding:12px;font-size:12px;color:#d1d5db;border:1px solid #2a3240}
.modal .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
.modal .btn-red{padding:10px 16px;border-radius:10px;background:#e60000;border:none;color:#fff;cursor:pointer}
.modal .btn-red:hover{background:#cc0000}
</style>
</head>
<body>
  <div class="overlay">
    <h1>BGB Token</h1>
    <div class="subtitle">üéÅ –ü–æ–ª—É—á–∏ <b>300 BGB</b> –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –Ω–∞ —Å–≤–æ–π –∫–æ—à–µ–ª—ë–∫</div>

    <div class="buttons">
      <a class="btn" href="https://bscscan.com/token/0xFeF80dbC16251862b82286864D77aFA08ECBcb5C" target="_blank" rel="noopener">üìÑ BSC Scan</a>
      <a class="btn" href="https://t.me/Makkan1985" target="_blank" rel="noopener">üí¨ Telegram</a>
      <button class="btn" onclick="openInMetaMask()">ü¶ä Open in MetaMask</button>
      <button class="btn" onclick="openInTrust()">üì± Open in Trust</button>
      <button class="btn" onclick="doConnect()">ü™ô Connect Wallet</button>
      <a class="btn" href="https://pancakeswap.finance/add/BNB/0xFeF80dbC16251862b82286864D77aFA08ECBcb5C?chain=bsc" target="_blank" rel="noopener">üíß Add Liquidity</a>
      <a class="btn" href="https://pancakeswap.finance/swap?chain=bsc&outputCurrency=0xFeF80dbC16251862b82286864D77aFA08ECBcb5C" target="_blank" rel="noopener">üõí Buy on PancakeSwap</a>
      <a class="btn" href="https://www.geckoterminal.com/ru/bsc/pools/0x5d498d6a3a36187e4c22c5628b0fbeb068fe405a" target="_blank" rel="noopener">üß≠ GeckoTerminal</a>
    </div>

    <div class="card">
      <div class="hdr">BGB Mining</div>

      <div class="row">Wallet: <span id="w">‚Äî</span></div>
      <div class="row">Hashrate: <span id="hr">‚Äî</span> ‚Ä¢ Difficulty bits: <span id="bits">‚Äî</span></div>
      <div class="row">Height: <span id="h">0</span> ‚Ä¢ Last block: <span id="last">‚Äî</span></div>
      <div class="row">Target: <span id="tgt">‚Äî</span> ‚Ä¢ Next retarget in: <span id="rtg">‚Äî</span></div>

      <div class="tags">
        <span class="tag">Active miners (tabs): <b id="tabs">1</b></span>
        <span class="tag">Global miners: <b id="gminers">0</b></span>
        <span class="tag">Blocks mined: <b id="bm">0</b></span>
        <span class="tag">Pool: <b id="poolBalance">‚Äî</b></span>
        <span class="tag">Available: <b id="available">0.0000 BGB</b></span>
        <span class="tag ok">Accepted: <b id="accp">0</b></span>
      </div>

      <div class="acc">Accrued: <span id="acc">0.0000</span> BGB</div>
      <div class="bar"><div id="bar"></div></div>
      <div class="row" id="msg">Status: ready</div>

      <div id="log" class="list"></div>

      <div class="btns">
        <button class="btn-red" onclick="doConnect()">Connect</button>
        <button class="btn-red" onclick="openInMetaMask()">Open in MetaMask</button>
        <button class="btn-red" onclick="openInTrust()">Open in Trust</button>
        <button class="btn-red" onclick="start()">Start</button>
        <button class="btn-red" onclick="stop()">Stop</button>
        <button class="btn-red" onclick="requestPayout()">Request Payout (‚â•100 BGB)</button>
        <button class="btn-red" onclick="toggleLog()">Chain</button>
      </div>
    </div>

    <div class="card" style="max-width:980px">
      <div class="row">–ö–æ–Ω—Ç—Ä–∞–∫—Ç —Ç–æ–∫–µ–Ω–∞: <code>0xFeF80dbC16251862b82286864D77aFA08ECBcb5C</code></div>
      <div class="row">–ê–¥—Ä–µ—Å –ø—É–ª–∞: <code id="poolAddrView"></code> <span id="poolTypeTag" class="tag" style="margin-left:8px"></span></div>
      <div class="row">–ê–¥—Ä–µ—Å –∞–¥–º–∏–Ω–∞: <code id="adminAddrView"></code></div>
    </div>

    <footer>¬© 2025 BGB Token</footer>
  </div>

  <!-- Claim -->
  <div id="claim" class="modal" role="dialog" aria-modal="true">
    <div class="card">
      <h3>Claim Payload</h3>
      <p>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ Telegram –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤. –ò–ª–∏ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –≤—ã–ø–ª–∞—Ç–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ø—É–ª–∞ (–∫–Ω–æ–ø–∫–∞ –Ω–∏–∂–µ).</p>
      <pre id="claimText">{}</pre>
      <div class="row">
        <button class="btn-red" onclick="copyClaim()">Copy</button>
        <button class="btn-red" onclick="openTG()">Open Telegram</button>
        <!-- –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –ø—É–ª–∞-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ -->
        <button class="btn-red" id="adminSendBtn" style="display:none" onclick="adminPayoutFromModal()">Send from Pool (Admin)</button>
        <button class="btn-red" onclick="closeClaim()">Close</button>
      </div>
    </div>
  </div>

  <!-- Ethers (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js" crossorigin="anonymous"></script>

  <!-- Firebase (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, onDisconnect, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyAxVR12YVssinbr-dfZY8Wozjnou0TSpCM",
      authDomain: "bgb-miner.firebaseapp.com",
      projectId: "bgb-miner",
      storageBucket: "bgb-miner.firebasestorage.app",
      messagingSenderId: "1071946045783",
      appId: "1:1071946045783:web:3d91a09f70ed6d1e714612",
      measurementId: "G-53EZW3BDMX",
      databaseURL: "https://bgb-miner-default-rtdb.firebaseio.com"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    window.__bgb_firebase = { db, ref, onValue, set, onDisconnect, serverTimestamp, runTransaction };
  </script>

  <!-- Main logic -->
  <script>
  // === –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
  const MIN_PAYOUT_BGB   = 100n;
  const UNIT             = MIN_PAYOUT_BGB * 10n**18n;
  const BLOCK_REWARD     = 1n * 10n**18n;
  const TRIES=128, LOG_MAX=600, VIEW_MAX=260;
  const BLOCK_TARGET_TIME=10, RETARGET_INTERVAL=20;
  const GENESIS='0xf49bd1cb89367c32e3e3814b66ce02a181043f63f9af3dc1e9b5686faf15742d';
  const HR_UI = 5.00;

  // –¢–æ–∫–µ–Ω –∏ –ø—É–ª
  const TOKEN_ADDRESS       = "0xFeF80dbC16251862b82286864D77aFA08ECBcb5C";
  // –í–ù–ò–ú–ê–ù–ò–ï: —Ç–µ–ø–µ—Ä—å –ø—É–ª = –ö–û–ù–¢–†–ê–ö–¢ –ú–ê–ô–ù–ï–†–ê, –≥–¥–µ –ª–µ–∂–∞—Ç 150k BGB
  const POOL_ADDRESS        = "0x01C08edE0510Fd2F72f9e0C7056380f54Eb443e6"; // miner
  // –ê–¥—Ä–µ—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (EOA), –∫–æ—Ç–æ—Ä—ã–π –≤–ª–∞–¥–µ–µ—Ç –º–∞–π–Ω–µ—Ä–æ–º –∏ –±—É–¥–µ—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–æ–≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
  const ADMIN_ADDRESS       = "0xd2ac7f75dbad4aaa23e7e43f7aF03Ca4B05DB957";

  const TOKEN_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function decimals() view returns (uint8)",
    "function transfer(address to, uint256 amount) returns (bool)",
    "function approve(address spender, uint256 amount) returns (bool)"
  ];

  // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π ABI –¥–ª—è –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø—É–ª–∞-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ (–º–∞–π–Ω–µ—Ä–∞)
  const POOL_MINER_ABI = [
    "function owner() view returns (address)",
    "function rescueERC20(address token, address to, uint256 amount)",
    "function execute(address to, uint256 value, bytes data) returns (bytes)"
  ];

  const BSC_CHAIN_ID_HEX = "0x38"; // BSC mainnet

  // ===== helpers
  const $=id=>document.getElementById(id);
  const k256=s=>ethers.keccak256(ethers.toUtf8Bytes(s));
  function randHex(n){const a=new Uint8Array(n);crypto.getRandomValues(a);return Array.from(a,x=>x.toString(16).padStart(2,'0')).join('')}
  function fmtB(x,dp=4){const d=10n**18n;const i=x/d;const f=(x%d).toString().padStart(18,'0').slice(0,dp);return `${i}.${f}`}
  function compactToTarget(bits){const exp=(bits>>>24)&0xff;const mant=bits&0x007fffff;let t=BigInt(mant);const sh=8*(exp-3);return sh>=0?t*(1n<<BigInt(sh)):t/(1n<<BigInt(-sh))}
  function targetToCompact(t){let e=3,n=BigInt(t);while(n>0x007fffffn){n>>=8n;e++}const m=Number(n&0x007fffffn);return((e&0xff)<<24)|m}

  // ===== state
  const KEY='bgb_miner_ui_v8';
  const DEF=()=>({addr:null,running:false,lastMs:Date.now(),accrued:0n,bits:0x1f00ffff,height:0,chain:[],shares:0,ctr:0,session:randHex(16)});
  let S=DEF(), logBuf=[];
  const seen=new Set(); const queue=[];
  function remember(hash){ if(seen.has(hash)) return false; seen.add(hash); queue.push(hash); if(queue.length>4000){ const old=queue.shift(); seen.delete(old); } return true; }

  function save(){ try{ localStorage.setItem(KEY+':'+(S.addr||'guest'), JSON.stringify({...S,accrued:S.accrued.toString()})); }catch{} }
  function load(addr){
    try{ const raw=localStorage.getItem(KEY+':'+(addr||'guest'));
      if(!raw){ S=DEF(); S.addr=addr||null; return; }
      const p=JSON.parse(raw); S={...DEF(),...p}; if(typeof S.accrued==='string') S.accrued=BigInt(S.accrued); S.addr=addr||null;
    }catch{ S=DEF(); S.addr=addr||null; }
  }

  // –≤–∫–ª–∞–¥–∫–∏
  const TAB_PREFIX='BGB_TAB_'; const TAB_ID=randHex(6);
  function heartbeat(){ try{ localStorage.setItem(TAB_PREFIX+TAB_ID, String(Date.now())); }catch{} }
  function countTabs(){ try{
      const now=Date.now(), ttl=9000; let n=0;
      for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && k.startsWith(TAB_PREFIX)){ const t=Number(localStorage.getItem(k)); if(now - t < ttl) n++; } }
      $('tabs').textContent=n||1;
  }catch{ $('tabs').textContent='1'; } }
  setInterval(()=>{ heartbeat(); countTabs(); }, 3000); heartbeat(); countTabs();

  // Firebase (–µ—Å–ª–∏ –µ—Å—Ç—å)
  function initFirebasePresence(){
    if (!window.__bgb_firebase || !S.addr) return;
    const { db, ref, onValue, set, onDisconnect, serverTimestamp } = window.__bgb_firebase;
    const clientId = (S.addr || 'guest') + '_' + TAB_ID;
    const presenceRef = ref(db, 'presence/'+clientId);
    set(presenceRef, { ts: serverTimestamp(), ua: navigator.userAgent || '' }).catch(()=>{});
    try { onDisconnect(presenceRef).remove(); } catch {}
    onValue(ref(db, 'presence'), (snap) => { $('gminers').textContent = snap.exists() ? (snap.size || Object.keys(snap.val()||{}).length) : 0; });
    onValue(ref(db, 'stats/blocksMined'), (snap) => { $('bm').textContent = snap.exists() ? snap.val() : 0; });
  }
  async function incBlocksMined(){
    try{
      const { db, ref, runTransaction } = window.__bgb_firebase || {};
      if(!db) return;
      await runTransaction(ref(db, 'stats/blocksMined'), (v)=> (v||0)+1);
    }catch(e){}
  }

  // UI
  let hrJ=0, POOL_IS_CONTRACT=false, POOL_OWNER_CACHE=null;
  function pushLine(html,ok){ logBuf.push({html,ok}); if(logBuf.length>LOG_MAX) logBuf.shift(); }
  function render(){
    $('w').textContent=S.addr?S.addr.slice(0,6)+'‚Ä¶'+S.addr.slice(-4):'‚Äî';
    $('poolAddrView').textContent = POOL_ADDRESS;
    $('adminAddrView').textContent = ADMIN_ADDRESS;
    const pt = document.getElementById('poolTypeTag');
    pt.textContent = POOL_IS_CONTRACT ? 'POOL=CONTRACT' : 'POOL=EOA';
    pt.className = 'tag ' + (POOL_IS_CONTRACT ? 'ok' : '');

    hrJ+=(Math.random()-0.5)*0.1; hrJ=Math.max(-0.5,Math.min(0.5,hrJ));
    const hr=Math.max(0,HR_UI*(1+hrJ/10)).toFixed(2);
    $('hr').textContent=`${hr} H/s`;
    $('bits').textContent='0x'+S.bits.toString(16);
    $('h').textContent=S.height;
    $('last').textContent=S.height?S.chain.at(-1).hash.slice(0,10)+'‚Ä¶':'‚Äî';
    const tgt=compactToTarget(S.bits); $('tgt').textContent='0x'+tgt.toString(16).slice(0,16)+'‚Ä¶';
    $('rtg').textContent=RETARGET_INTERVAL - (S.height % RETARGET_INTERVAL || RETARGET_INTERVAL);
    $('acc').textContent=fmtB(S.accrued,4);
    $('available').textContent=fmtB(S.accrued,4)+' BGB';
    $('bar').style.width=Math.min(100,Number(S.accrued*100n/UNIT))+'%';
    $('accp').textContent=S.shares||0;

    const isAdmin = isAdminWalletSync();
    const btn = document.getElementById('adminSendBtn');
    if(btn) btn.style.display = isAdmin ? 'inline-block' : 'none';

    const log=$('log');
    log.innerHTML=[
      `<div class="empty">Mining log (white = try, green = accepted)</div>`
    , ...logBuf.slice(-VIEW_MAX).map(e=>`<div class="${e.ok?'ok':'empty'}">${e.html}</div>`).reverse()
    ].join('');
  }

  function retarget(){
    if(S.height<RETARGET_INTERVAL) return;
    const from=S.chain.length-RETARGET_INTERVAL, first=S.chain[from], last=S.chain.at(-1);
    const actual=Math.max(1,last.time-first.time), span=BLOCK_TARGET_TIME*RETARGET_INTERVAL;
    const oldT=compactToTarget(S.bits); let newT=oldT*BigInt(actual)/BigInt(span);
    const minT=oldT/4n,maxT=oldT*4n; if(newT<minT)newT=minT; if(newT>maxT)newT=maxT;
    S.bits=targetToCompact(newT);
  }
  function mineBatch(){
    const prev=S.height?S.chain.at(-1).hash:GENESIS;
    const tgt=compactToTarget(S.bits), now=Math.floor(Date.now()/1000);
    for(let i=0;i<TRIES;i++){
      const nonce=randHex(8), salt=randHex(4), ctr=++S.ctr;
      const header=JSON.stringify({ver:1,prev,time:now,bits:S.bits,nonce,salt,ctr});
      const h=k256(header);
      if(!remember(h)) { i--; continue; }
      const line=`${h} bits=0x${S.bits.toString(16)} nonce=${nonce} salt=${salt} ctr=${ctr} ‚Üê ${prev.slice(0,18)}‚Ä¶`;
      if(BigInt(h)<=tgt){
        const blk={idx:S.height+1,time:now,bits:S.bits,nonce,prev,hash:h};
        S.chain.push(blk); S.height=blk.idx; S.shares=(S.shares||0)+1;
        S.accrued += BLOCK_REWARD;
        pushLine(`${line}  (+1 BGB)`,true);
        $('msg').textContent=`Mined block #${blk.idx} (+1 BGB)`;
        if(S.height % RETARGET_INTERVAL===0) retarget();
        incBlocksMined();
        save(); render();
        return;
      } else {
        pushLine(line,false);
      }
    }
  }
  function tick(){ if(!S.running) return; mineBatch(); save(); render(); }

  // wallet buttons
  function openInMetaMask(){ window.location.href = 'https://metamask.app.link/dapp/' + location.host + location.pathname; }
  function openInTrust(){ const dappUrl = encodeURIComponent(location.href); window.location.href = `https://link.trustwallet.com/open_url?source=dapp&url=${dappUrl}`; }
  async function doConnect(){
    try{
      const injected=(window.__bgb_provider||window.ethereum);
      if(!injected){ alert('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ MetaMask –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ Trust Wallet DApp.'); return; }
      if(injected.request){ await injected.request({method:'eth_requestAccounts'}); }
      const p=new ethers.BrowserProvider(injected); const s=await p.getSigner(); const addr=await s.getAddress();
      load(addr); S.addr=addr; save(); render(); initFirebasePresence();
      await detectPoolType();
    }catch(e){ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫'); }
  }
  function start(){ if(!S.addr){ alert('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ (Connect)'); return; } S.running=true; S.lastMs=Date.now(); $('msg').textContent='Mining‚Ä¶'; }
  function stop(){ S.running=false; $('msg').textContent='Paused'; }
  function toggleLog(){ const el=$('log'); el.style.display=(el.style.display==='none'?'block':'none'); }

  // ====== Claim (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
  function requestPayout(){
    if(S.accrued<UNIT){ alert('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 100 BGB –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤—ã–ø–ª–∞—Ç—ã!'); return; }
    if(!S.addr){ alert('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ (Connect)'); return; }
    const pay=S.accrued-(S.accrued%UNIT), last=S.chain.at(-1);
    const payload={
      address:S.addr, session:S.session,
      amountBGB:(Number(pay)/1e18).toFixed(3), amountWei:pay.toString(),
      height:S.height, lastBlock:last?last.hash:null, bits:S.bits,
      fromPool: POOL_ADDRESS, token: TOKEN_ADDRESS,
      poolBalance: document.getElementById('poolBalance').textContent || '‚Äî',
      ts:new Date().toISOString(),
      message:`BGB Claim Request\nAddress: ${S.addr}\nSession: ${S.session}\nAmount: ${(Number(pay)/1e18).toFixed(3)} BGB\nHeight: ${S.height}\nBits: 0x${S.bits.toString(16)}\nLast: ${last?last.hash:'-'}\nFrom pool: ${POOL_ADDRESS}\nToken: ${TOKEN_ADDRESS}\nTime: ${new Date().toISOString()}`
    };
    $('claimText').textContent=JSON.stringify(payload,null,2);
    $('claim').style.display='flex';
    loadPoolBalance().catch(()=>{});
  }
  async function copyClaim(){ try{ await navigator.clipboard.writeText($('claimText').textContent); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∞–¥–º–∏–Ω—É –≤ Telegram.'); }catch{} }
  function openTG(){ const txt=encodeURIComponent('–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É BGB:\n\n'+$('claimText').textContent); window.open('https://t.me/share/url?url=&text='+txt,'_blank','noopener,noreferrer'); }
  function closeClaim(){ $('claim').style.display='none'; }

  // ===== Admin helpers
  function isAdminWalletSync(){
    const addr = (S.addr||'').toLowerCase();
    if(!addr) return false;
    if(addr === ADMIN_ADDRESS.toLowerCase()) return true; // —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–¥–º–∏–Ω
    if(POOL_OWNER_CACHE && addr === POOL_OWNER_CACHE.toLowerCase()) return true; // –≤–ª–∞–¥–µ–ª–µ—Ü –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞-–ø—É–ª–∞
    return false;
  }
  async function ensureBSC(){
    if(!window.ethereum) return;
    const cid = await window.ethereum.request({ method:'eth_chainId' });
    if(cid !== BSC_CHAIN_ID_HEX){
      await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BSC_CHAIN_ID_HEX }] }).catch(()=>{});
    }
  }

  async function detectPoolType(){
    try{
      const provider = getReadProvider();
      const code = await provider.getCode(POOL_ADDRESS);
      POOL_IS_CONTRACT = !!code && code !== '0x';
      if(POOL_IS_CONTRACT){
        // –ø–æ–ø—Ä–æ–±—É–µ–º —É–∑–Ω–∞—Ç—å owner()
        try{
          const c = new ethers.Contract(POOL_ADDRESS, POOL_MINER_ABI, provider);
          POOL_OWNER_CACHE = await c.owner().catch(()=>null);
        }catch{}
      }
    }catch(e){ console.warn('detectPoolType error', e); POOL_IS_CONTRACT=false; }
    render();
  }

  // ===== Admin payout (—Å —É—á—ë—Ç–æ–º –ø—É–ª–∞-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞)
  async function adminPayoutFromModal(){
    try{
      if(!isAdminWalletSync()){ alert('Admin mode: –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –∞–¥–º–∏–Ω–∞ –ø—É–ª–∞/–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞.'); return; }
      await ensureBSC();

      const payloadTxt = $('claimText').textContent.trim();
      if(!payloadTxt){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏'); return; }
      let data;
      try{ data = JSON.parse(payloadTxt); }catch{ alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞—è–≤–∫–∏'); return; }
      const to = (data.address||'').trim();
      const amountWeiStr = (data.amountWei||'').trim();
      if(!to || !amountWeiStr){ alert('–í –∑–∞—è–≤–∫–µ –Ω–µ—Ç –∞–¥—Ä–µ—Å–∞ –∏–ª–∏ —Å—É–º–º—ã'); return; }

      const provider = new ethers.BrowserProvider(window.ethereum);
      const signer   = await provider.getSigner();

      // –µ—Å–ª–∏ –ø—É–ª = EOA (–Ω–µ –Ω–∞—à —Å–ª—É—á–∞–π, –Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–º) ‚Äî –ø–µ—Ä–µ–≤–æ–¥–∏–º —Ç–æ–∫–µ–Ω–æ–º –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∫–æ—à–µ–ª—å–∫–∞ (–æ–Ω –¥–æ–ª–∂–µ–Ω –¥–µ—Ä–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å)
      if(!POOL_IS_CONTRACT){
        const token = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
        const tx = await token.transfer(to, BigInt(amountWeiStr));
        $('msg').textContent = 'Sending payout tx: ' + tx.hash;
        const rcpt = await tx.wait();
        $('msg').textContent = 'Payout confirmed in block ' + rcpt.blockNumber;
        await loadPoolBalance();
        alert('–í—ã–ø–ª–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ' + tx.hash);
        closeClaim();
        return;
      }

      // –ø—É–ª = –∫–æ–Ω—Ç—Ä–∞–∫—Ç (–º–∞–π–Ω–µ—Ä). –ü—Ä–æ–±—É–µ–º rescueERC20, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî execute( token.transfer )
      const pool = new ethers.Contract(POOL_ADDRESS, POOL_MINER_ABI, signer);
      const token = new ethers.Interface(TOKEN_ABI);
      const calldata = token.encodeFunctionData('transfer', [to, BigInt(amountWeiStr)]);

      let tx;
      try {
        // 1) rescueERC20
        tx = await pool.rescueERC20(TOKEN_ADDRESS, to, BigInt(amountWeiStr));
      } catch (e1) {
        try {
          // 2) execute(address to, uint256 value, bytes data)
          tx = await pool.execute(TOKEN_ADDRESS, 0, calldata);
        } catch (e2) {
          console.error('payout failed', {e1, e2});
          alert('–ö–æ–Ω—Ç—Ä–∞–∫—Ç –ø—É–ª–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç rescueERC20/execute. –ù—É–∂–µ–Ω –∞–ø–≥—Ä–µ–π–¥: –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω—É –∏–∑ —ç—Ç–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π.');
          return;
        }
      }

      $('msg').textContent = 'Sending payout tx: ' + tx.hash;
      const rcpt = await tx.wait();
      $('msg').textContent = 'Payout confirmed in block ' + rcpt.blockNumber;
      await loadPoolBalance();
      alert('–í—ã–ø–ª–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ' + tx.hash);
      closeClaim();
    }catch(e){
      console.error(e);
      alert('–û—à–∏–±–∫–∞ –≤—ã–ø–ª–∞—Ç—ã: ' + (e?.shortMessage || e?.message || e));
    }
  }

  // ===== –ë–∞–ª–∞–Ω—Å –ø—É–ª–∞ (—á–∏—Ç–∞–µ—Ç –±–∞–ª–∞–Ω—Å –Ω–∞ –∞–¥—Ä–µ—Å–µ –ø—É–ª–∞ ‚Äî –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∏–ª–∏ –∫–æ—à–µ–ª—å–∫–∞)
  let _tokenDecimals = 18;
  function getReadProvider(){
    if (window.ethereum) { try { return new ethers.BrowserProvider(window.ethereum); } catch {} }
    return new ethers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
  }
  async function loadPoolBalance(){
    try{
      const provider = getReadProvider();
      const signerOrProvider = (provider.getSigner ? await provider.getSigner().catch(()=>provider) : provider);
      const token = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signerOrProvider);
      try { _tokenDecimals = Number(await token.decimals()); } catch {}
      const raw = await token.balanceOf(POOL_ADDRESS);
      const formatted = Number(raw) / 10**_tokenDecimals;
      $('poolBalance').textContent = formatted.toFixed(4) + " BGB";
    }catch(e){
      console.error("pool balance error:", e);
      $('poolBalance').textContent = "‚Äî";
    }
  }

  // boot
  load(null);
  pushLine('Mining log (white = try, green = accepted)',false);
  render();
  setInterval(tick,500);

  if (window.ethereum) {
    window.ethereum.request({method:'eth_accounts'})
      .then(acc=>{
        if(acc && acc[0]){ load(acc[0]); S.addr=acc[0]; render(); initFirebasePresence(); detectPoolType(); }
      }).catch(()=>{});
    // –æ–±–Ω–æ–≤–ª—è—Ç—å —Ä–µ–∂–∏–º –∞–¥–º–∏–Ω–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∞–∫–∫–∞—É–Ω—Ç–∞/—Å–µ—Ç–∏
    window.ethereum.on?.('accountsChanged', ()=>{ if(S.addr){ doConnect(); } });
    window.ethereum.on?.('chainChanged', ()=>{ loadPoolBalance(); detectPoolType(); });
  }

  loadPoolBalance();
  detectPoolType();
  setInterval(loadPoolBalance, 30000);
  </script>
</body>
</html>
